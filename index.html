<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALBO Solutions ‚Äì Business Case Management Platform</title>

  <!-- === External Libraries === -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- === Styles === -->
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/cockpit-COMPLETE.css" />

  <!-- === Modal Style (keine √Ñnderung) === -->
  <style>
    .modal {
      display: flex !important;
      position: fixed !important;
      z-index: 10000 !important;
      left: 0 !important;
      top: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background-color: rgba(0, 0, 0, 0.5) !important;
      backdrop-filter: blur(2px) !important;
      align-items: center !important;
      justify-content: center !important;
      overflow-y: auto !important;
      padding: 20px !important;
    }
    .modal-content {
      background: #fff !important;
      border-radius: 12px !important;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
      width: 90% !important;
      max-width: 600px !important;
      max-height: 90vh !important;
      overflow: hidden !important;
      display: flex !important;
      flex-direction: column !important;
      margin: auto !important;
      position: relative !important;
    }
    .modal-header,
    .modal-footer {
      padding: 24px !important;
      border-bottom: 1px solid #e2e8f0 !important;
      flex-shrink: 0 !important;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: #1e3a8a;
    }
    .btn-close {
      background: transparent;
      border: none;
      font-size: 24px;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-close:hover {
      background: #f1f5f9;
      border-radius: 4px;
      color: #1e3a8a;
    }
    .modal-body {
      padding: 24px !important;
      overflow-y: auto !important;
      flex: 1 !important;
      max-height: calc(90vh - 160px) !important;
    }
  </style>
</head>
<body>

  <!-- === HEADER === -->
  <header class="dashboard-header">
    <div class="header-left">
      <h1>ALBO Solutions ‚Äì Business Case Management</h1>
      <span class="header-subtitle">KI-gest√ºtzte Echtzeit-Analyse mit intelligenten Handlungsempfehlungen</span>
    </div>
    <div class="header-stats">
      <div class="stat"><div class="stat-value" id="npv-value">+44,7 M‚Ç¨</div><div class="stat-label">NPV (9 Jahre)</div></div>
      <div class="stat"><div class="stat-value" id="payback-value">3,4 J</div><div class="stat-label">PAYBACK</div></div>
      <div class="stat"><div class="stat-value" id="revenue-value">117,8 M‚Ç¨</div><div class="stat-label">TOTAL REVENUE</div></div>
      <div class="stat"><div class="stat-value" id="margin-value">34 %</div><div class="stat-label">√ò DB2-MARGE</div></div>
    </div>
  </header>

  <!-- === NAVIGATION === -->
  <nav class="main-navigation">
    <button class="tab-btn active" onclick="switchTab('cockpit')">üìä Cockpit</button>
    <button class="tab-btn" onclick="switchTab('projekte')">üíº Projekte</button>
    <button class="tab-btn" onclick="switchTab('performance')">üìà Performance</button>
    <button class="tab-btn" onclick="switchTab('admin')">‚öôÔ∏è Admin</button>
  </nav>

  <!-- === MAIN WRAPPER === -->
  <div class="main-content">
    <main class="dashboard-main">
      <!-- === TAB: COCKPIT === -->
      <div id="tab-cockpit" class="tab-content active">
        <div class="portfolio-kpis"></div>
        <div class="bcg-matrix-container"></div>
        <div class="strategic-recommendations"></div>
      </div>

      <!-- === TAB: PROJEKTE === -->
      <div id="tab-projekte" class="tab-content">
        <div id="projekt-overview">
          <div class="portfolio-overview-header">
            <div class="portfolio-label">PORTFOLIO OVERVIEW</div>
            <div class="portfolio-stats">
              <div class="portfolio-stat"><span id="stat-total-projects">0</span><span>PROJEKTE</span></div>
              <div class="portfolio-stat portfolio-stat-success"><span id="stat-active-projects">0</span><span>AKTIV</span></div>
              <div class="portfolio-stat portfolio-stat-warning"><span id="stat-onhold-projects">0</span><span>ON HOLD</span></div>
              <div class="portfolio-stat portfolio-stat-neutral"><span id="stat-completed-projects">0</span><span>ABGESCHLOSSEN</span></div>
            </div>
          </div>

          <div class="section-header-with-views">
            <div class="section-title"><span class="section-icon">üìÅ</span><h2>Projekt Portfolio</h2></div>
            <div class="view-switcher">
              <button class="view-btn active" data-view="liste" onclick="switchProjectView('liste')">‚ò∞ Liste</button>
              <button class="view-btn" data-view="karten" onclick="switchProjectView('karten')">‚ñ¶ Karten</button>
              <button class="view-btn" data-view="kompakt" onclick="switchProjectView('kompakt')">‚â° Kompakt</button>
            </div>
          </div>

          <!-- Filter & Suchfeld -->
          <div class="table-controls">
            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input id="projekt-search" type="text" placeholder="Projekte durchsuchen‚Ä¶" oninput="filterProjekte()" />
            </div>
            <div class="filter-group">
              <select id="projekt-filter-status" onchange="filterProjekte()">
                <option value="alle">Alle Status</option>
                <option value="aktiv">Aktiv</option>
                <option value="planung">Planung</option>
                <option value="on-hold">On Hold</option>
                <option value="abgeschlossen">Abgeschlossen</option>
              </select>
              <select id="projekt-sort" onchange="sortProjekte()">
                <option value="name">Sortieren: Name</option>
                <option value="start">Sortieren: Startdatum</option>
                <option value="status">Sortieren: Status</option>
                <option value="owner">Sortieren: Owner</option>
              </select>
            </div>
          </div>

          <!-- Projekttabelle -->
          <div id="projekt-list-container">
            <div class="table-container">
              <div id="projekt-loading-indicator" class="loading-indicator"><div class="spinner"></div><p>Projekte werden geladen‚Ä¶</p></div>
              <table class="data-table">
                <thead>
                  <tr>
                    <th width="40"><input type="checkbox" id="select-all-projects" onchange="toggleAllProjects(this)" /></th>
                    <th>PROJEKT</th><th>DIVISION</th><th>OWNER</th>
                    <th width="100">START</th><th width="100">END</th><th width="100">STATUS</th><th width="120">AKTIONEN</th>
                  </tr>
                </thead>
                <tbody id="projekt-list-tbody"></tbody>
              </table>
            </div>
          </div>

          <div class="centered-action">
            <button class="btn btn-primary" onclick="openCreateProjektModal()">‚ûï Neues Projekt anlegen</button>
          </div>

          <div id="bulk-actions-bar" class="bulk-actions-bar">
            <div class="bulk-actions-info"><span id="bulk-count">0</span> Projekte ausgew√§hlt</div>
            <div class="bulk-actions-buttons">
              <select id="bulk-status-change">
                <option value="">Status √§ndern‚Ä¶</option>
                <option value="Planung">‚Üí Planung</option>
                <option value="Aktiv">‚Üí Aktiv</option>
                <option value="On Hold">‚Üí On Hold</option>
                <option value="Abgeschlossen">‚Üí Abgeschlossen</option>
              </select>
              <button class="btn btn-secondary" onclick="bulkStatusChange()">Anwenden</button>
              <button class="btn btn-danger" onclick="bulkDeleteProjekte()">üóëÔ∏è L√∂schen</button>
            </div>
          </div>
        </div>

        <!-- === Weitere Views (Detail, Artikel, Kosten ‚Ä¶) werden durch JS-Module geladen === -->
        <div id="projekt-detail-view" style="display:none;"></div>
        <div id="artikel-overview" style="display:none;"></div>
        <div id="artikel-detail-view" style="display:none;"></div>
      </div>

      <!-- === TAB: PERFORMANCE === -->
      <div id="tab-performance" class="tab-content">
        <div class="insights-container">
          <h2>üìà Performance Controlling</h2>
          <p>Plan-Ist-Forecast √ºber alle Projekte (Coming Soon)</p>
          <div class="insights-placeholder">
            <div class="placeholder-icon">üìä</div>
            <h3>In Entwicklung</h3>
            <p>Bald verf√ºgbar: Plan-Ist-Vergleiche, Rolling Forecasts und Performance-Analysen.</p>
          </div>
        </div>
      </div>

      <!-- === TAB: ADMIN === -->
      <div id="tab-admin" class="tab-content">
        <div class="insights-container">
          <h2>‚öôÔ∏è Administration</h2>
          <p>Einstellungen und Stammdaten (Coming Soon)</p>
          <div class="insights-placeholder">
            <div class="placeholder-icon">üîß</div>
            <h3>In Entwicklung</h3>
            <p>Hier werden bald Einstellungen, Stammdaten-Verwaltung und System-Konfigurationen verf√ºgbar sein.</p>
          </div>
        </div>
      </div>
    </main>

    <!-- === ALBO-Sidebar === -->
    <aside class="sidebar" id="albo-sidebar">
      <div class="ai-header">
        <div class="ai-status">
          <div class="ai-status-indicator"></div>
          <div>
            <div style="font-weight:700;font-size:16px;">ü§ñ ALBO Senior Controller</div>
            <div style="font-size:11px;opacity:.9;">Live Business Case Monitoring</div>
          </div>
        </div>
      </div>
      <div class="albo-monitor-feed">
        <div class="albo-chat-messages" id="albo-chat-messages"></div>
        <div class="albo-chat-input-wrapper">
          <input id="albo-chat-input" class="albo-chat-input"
                 placeholder="Frage ALBO etwas‚Ä¶" onkeypress="if(event.key==='Enter') sendAlboMessage()" />
          <button class="albo-chat-send" onclick="sendAlboMessage()">‚Üí</button>
        </div>
      </div>
    </aside>
  </div>

    <!-- === SCRIPTS === -->
  <script type="module">
    import './js/main.js';
    import { state } from './js/state.js';
    import * as helpers from './js/helpers.js';
    import { renderProjektOverview, updateProjektStats } from './js/modules/projekte.js';
    import { renderArtikelListByProjekt } from './js/modules/artikel.js';

    // ==== DOM Ready ====
    document.addEventListener('DOMContentLoaded', () => {
      const artikelView = document.getElementById('artikel-detail-view');
      if (artikelView && !window.cfoDashboard?.currentArtikel) {
        artikelView.style.display = 'none';
      }
    });

    // ==== Make modules globally available for inline handlers ====
    window.state = state;
    window.helpers = helpers;
    window.renderProjektOverview = renderProjektOverview;
    window.updateProjektStats = updateProjektStats;
    window.renderArtikelListByProjekt = renderArtikelListByProjekt;

    // =====================================================
    // üîπ switchProjektTab ‚Äì Hauptfunktion f√ºr Tab-Steuerung
    // =====================================================
    window.switchProjektTab = async function (tabName) {
      console.log('üìë Switching projekt tab:', tabName);

      // Buttons & Content resetten
      document.querySelectorAll('.detail-tab').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.projekt-tab-content').forEach(c => c.classList.remove('active'));

      // Aktivieren
      const targetButton = document.querySelector(`[onclick="switchProjektTab('${tabName}')"]`);
      const targetContent = document.getElementById(`projekt-tab-${tabName}`);
      if (targetButton) targetButton.classList.add('active');
      if (targetContent) targetContent.classList.add('active');

      // State speichern
      if (window.state) {
        state.currentProjektTab = tabName;
        state.projektViewMode = 'detail';
        state.saveState();
      }

      // Custom Event
      document.dispatchEvent(new CustomEvent('tab-changed', {
        detail: {
          tab: tabName,
          projekt: window.cfoDashboard?.currentProjekt,
          artikel: window.cfoDashboard?.currentArtikel
        }
      }));

      // Dynamisches Nachladen je Tab
      try {
        if (tabName === 'artikel') {
          const projektId = window.cfoDashboard.currentProjekt;
          if (projektId && window.renderArtikelListByProjekt) {
            window.renderArtikelListByProjekt();
          }
        } else if (tabName === 'uebersicht') {
          const module = await import('./js/modules/uebersicht.js');
          module.renderUebersicht?.();
        } else if (tabName === 'projektkosten') {
          const module = await import('./js/modules/projektkosten.js');
          module.renderProjektkosten?.();
        } else if (tabName === 'wirtschaftlichkeit') {
          const module = await import('./js/modules/wirtschaftlichkeit/wirtschaftlichkeit.js');
          module.renderProjektWirtschaftlichkeit?.();
        } else if (tabName === 'dashboard') {
          const module = await import('./js/modules/dashboard/dashboard.js');
          module.renderProjektDashboard?.();
        }
      } catch (err) {
        console.error('Fehler beim Laden des Tabs:', tabName, err);
      }
    };

    // =====================================================
    // üîπ Projekt √∂ffnen
    // =====================================================
    window.openProjektDetail = function (projektId) {
      const projekt = state.getProjekt(projektId);
      if (!projekt) return console.error('Projekt nicht gefunden:', projektId);

      window.cfoDashboard.currentProjekt = projektId;
      state.currentProjekt = projektId;
      state.projektViewMode = 'detail';
      state.currentProjektTab = 'uebersicht';
      state.currentArtikel = null;
      state.saveState();

      document.getElementById('projekt-overview').style.display = 'none';
      document.getElementById('projekt-detail-view').style.display = 'block';
      document.getElementById('projekt-detail-breadcrumb').textContent = projekt.name;
      document.getElementById('projekt-detail-title').textContent = projekt.name;

      window.switchProjektTab('uebersicht');
    };

    // =====================================================
    // üîπ Artikel-Navigation (vorheriger/n√§chster)
    // =====================================================
    window.navigateToPreviousArtikel = function () {
      const currentProjekt = window.cfoDashboard.currentProjekt;
      const artikelListe = state.getArtikelByProjekt(currentProjekt);
      if (!artikelListe?.length) return;

      const currentIndex = artikelListe.findIndex(a => a.id === window.cfoDashboard.currentArtikel);
      if (currentIndex > 0) window.openArtikelDetail(artikelListe[currentIndex - 1].id);
    };

    window.navigateToNextArtikel = function () {
      const currentProjekt = window.cfoDashboard.currentProjekt;
      const artikelListe = state.getArtikelByProjekt(currentProjekt);
      if (!artikelListe?.length) return;

      const currentIndex = artikelListe.findIndex(a => a.id === window.cfoDashboard.currentArtikel);
      if (currentIndex < artikelListe.length - 1)
        window.openArtikelDetail(artikelListe[currentIndex + 1].id);
    };

    // =====================================================
    // üîπ Artikel-Navigation aktualisieren (Buttons, Breadcrumbs)
    // =====================================================
    window.updateArtikelNavigation = function () {
      const currentProjekt = window.cfoDashboard.currentProjekt;
      const currentArtikel = window.cfoDashboard.currentArtikel;
      const artikelListe = state.getArtikelByProjekt(currentProjekt);

      if (!artikelListe?.length) return;

      const idx = artikelListe.findIndex(a => a.id === currentArtikel);
      const artikel = artikelListe[idx];
      if (!artikel) return;

      document.getElementById('artikel-position').textContent = idx + 1;
      document.getElementById('artikel-total').textContent = artikelListe.length;
      document.getElementById('prev-artikel-btn').disabled = idx === 0;
      document.getElementById('next-artikel-btn').disabled = idx === artikelListe.length - 1;

      document.getElementById('artikel-breadcrumb-name').textContent = artikel.name || 'Artikel bearbeiten';
      document.getElementById('artikel-detail-title').textContent = `‚úèÔ∏è ${artikel.name || 'Artikel bearbeiten'}`;
    };

    console.log('‚úÖ ALBO index.html Scripts loaded successfully');
  </script>

  <!-- === Optional: Debug Observer (Finanz-Parameter Tracker) === -->
  <script>
    console.log('üîç Beobachte DOM auf "Finanz-Parameter"-Sektionen ‚Ä¶');
    const observer = new MutationObserver(mutations => {
      for (const m of mutations) {
        for (const node of m.addedNodes) {
          if (node.nodeType === 1 && node.textContent.includes('Finanz-Parameter')) {
            console.warn('üî¥ "Finanz-Parameter"-Block erkannt:', node);
            observer.disconnect();
          }
        }
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
  </script>

</body>
</html>
