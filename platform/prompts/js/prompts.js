/* ========================================== */
/* ALBO PROMPTS - 3-LEVEL HIERARCHY */
/* Multi-Role with MECE Theme Structure */
/* ========================================== */

class PromptsEngine {
    constructor() {
        this.taskQueue = [];
        this.allPrompts = this.getAllPrompts();
        this.currentView = 'roles';  // 'roles' | 'themes' | 'prompts'
        this.currentMode = 'templates';
        this.currentRole = null;
        this.currentTheme = null;
        this.currentPrompt = null;
        this.userAnswers = {};
        this.searchQuery = '';
        
        // MECE Theme Mapping
        this.themeMapping = this.getThemeMapping();
        
        console.log('üí° Prompts Engine initialized (3-Level Hierarchy)');
        console.log(`üìö Loaded ${this.allPrompts.length} prompts across ${this.getRoleCount()} roles`);

        // üÜï Inject Split-Screen CSS
        this.injectSplitScreenCSS();
    }

    getThemeMapping() {
        return {
    "Controller": {
        "icon": "üìä",
        "themes": [
            {"id": "kostenrechnung", "name": "üí∞ Kostenrechnung", "keywords": ["Kostenartenrechnung", "Materialkostenanalyse", "Personalkostenanalyse", "Kostenstellenrechnung", "Gemeinkosten", "Kostenstellenstruktur", "Ineffiziente Kostenstellen", "Kostentr√§gerrechnung", "Einstufige Deckungsbeitragsrechnung", "Mehrstufige Deckungsbeitragsrechnung", "Deckungsbeitragsanalyse", "Prozesskostenrechnung", "Activity-Based"]},
            {"id": "kalkulation", "name": "üìê Kalkulation", "keywords": ["Zuschlagskalkulation", "Angebotspreis", "Maschinenstundensatz", "Verrechnung", "Herstellkosten je Einheit", "Variantenprodukte", "Komplexit√§t sauber", "Vertriebs-/Preiskalkulation", "Zielmarge", "Deckungsbeitragskalkulation", "Produktlinien", "Nachkalkulation", "Plankalkulation", "Abweichungen", "Kalkulation f√ºr Projektgesch√§ft", "Zeit, Material, Overhead", "Kostent√§gerzeitrechnung", "F√ºr komplexe Auftr√§ge", "Kalkulationssimulation", "Preis-/Kosten-/Mengen√§nderungen"]},
            {"id": "budgetierung", "name": "üìà Budgetierung & Forecasting", "keywords": ["Integrierte Budgetierung", "Abteilungs√ºbergreifend", "Szenariobasierte Budgetierung", "Marketing-Budgetierung", "ROI", "Budgetierung von Fixkosten und variablen", "Kurzfrist-Forecasting", "bis 6 Monate", "Rolling Forecast", "Long-Term Forecast", "Treiberbasierte Planung", "Echtzeit-Monitoring von Budgetabweichungen", "Ursachenanalyse von Budgetabweichungen", "Agile Forecasting", "Planning"]},
            {"id": "investition", "name": "üíº Investitionsplanung", "keywords": ["Kostenvergleichsrechnung", "Gewinnvergleichsrechnung", "Rentabilit√§tsvergleichsrechnung", "Amortisationsrechnung", "Kapitalwertmethode", "Interne Zinsfu√ü-Methode", "Annuit√§tenmethode", "Dynamische Amortisationsrechnung", "Optimale Nutzungsdauer", "Ersatzzeitpunkt", "Investitionsplanung inkl. Risiko-", "Sensitivit√§tsanalyse"]},
            {"id": "kennzahlen", "name": "üìä Kennzahlensysteme", "keywords": ["Analyse der Verm√∂gensstruktur", "Kapitalstruktur-Analyse", "Liquidit√§tskennzahlen", "Cash Management Optimierung", "Rentabilit√§tskennzahlen", "Performance bewerten", "steuern", "Cashflow-Kennzahlen", "Innenfinanzierungskraft", "Kosten- und Ergebnisstruktur", "Material-, Personal-", "Fixkostenanalyse", "Case - Vertriebs-", "Marketingkostenanalyse", "Kennzahlensysteme", "DuPont", "Value-based KPIs", "Balanced Scorecard", "Fr√ºhwarn-", "Krisenkennzahlen", "Branchen-", "Benchmark-Kennzahlen", "KPI-Storytelling", "Management-Kommunikation"]},
            {"id": "berichterstattung", "name": "üìÑ Finanzberichterstattung", "keywords": ["Monats-, Quartals-", "Jahresabschl√ºsse professionell", "Abweichungsanalyse mit Handlungsempfehlung", "Konzernreporting", "Konsolidierung", "Forecasting", "Rolling Forecasts", "Kennzahlen-Reporting", "KPIs", "Financial Ratios", "Management Reporting", "Visualisierung", "Storytelling im Reporting", "Sonderanalysen", "Ad-hoc-Reporting", "Berichtskommentierung", "Ableitung von Handlungsempfehlungen", "Automatisierung und KI im Reporting"]},
            {"id": "konzern", "name": "üè¢ Konzerncontrolling", "keywords": ["Konzernreporting", "GuV, Bilanz, Cashflow", "KPI-Analyse", "Intercompany-Abstimmung", "Konsolidierungsvorbereitung", "Kapitalkonsolidierung", "Analyse", "Darstellung", "Aufwands-", "Ertragskonsolidierung", "Zwischenergebniseliminierung", "Konzern-Cashflow-Rechnung", "automatisiert", "interpretierbar", "Segment-", "Spartenreporting", "Benchmark", "Handlungsempfehlungen", "Konzern-Kennzahlenanalyse", "Konzern-Prognose", "Forecast", "Szenario-Logik", "Kommentierung von Konzernabschl√ºssen", "KPI-Storytelling auf Konzernebene"]},
            {"id": "projekt", "name": "üéØ Projektcontrolling", "keywords": ["Projektkostenplanung", "Bottom-up", "Top-down", "Projektstruktur-", "Meilensteinplanung", "Projektbudget-Controlling", "Mittelabruf", "Projektstatusbericht", "Ampellogik", "Ma√ünahmen", "Projekt-Deckungsbeitragsrechnung", "Forecast", "Szenarien im Projektverlauf", "Projektrisiken identifizieren", "managen", "Projektkommunikation", "Entscheidungsvorlagen", "Projektabschlussanalyse", "Abweichungen, Learnings", "Erfolgsfaktoren", "Erfolgsfaktoren-Profil", "Benchmarking", "Was gute Projekte ausmacht"]},
            {"id": "businesscase", "name": "üí° Business Case Controlling", "keywords": ["Klassischer Business Case f√ºr Produktinvestitionen", "Ganzheitlicher Investitions-Business-Case", "produktionsnahe Industrien", "Business Case f√ºr Software", "Digitalisierung", "Effizienz-", "Skalierungslogik", "Make-or-Buy Business Case", "wirtschaftlichem und strategischem Vergleich", "Business Case in Krisensituationen", "Turnaround, Standortschlie√üung, Rettungsszenarien", "Szenario-basierter Business Case", "Base / Best / Stress", "ESG-", "Nachhaltigkeits-Business Case", "Impact-Logik", "nicht-monet√§re Bewertung", "Kunden-/Marktbasierter Business Case", "Neukundengewinnung, CLV, Vertriebspotenzial", "Interner Business Case f√ºr Transformation", "Change", "Prozesse, Kultur, Organisation", "Branchenvergleich: Industrie vs. Software", "Business Case Logik, KPIs, Steuerung", "Business Case One-Pager", "Management Summary f√ºr Investitionsentscheidung"]},
            {"id": "digital", "name": "üöÄ Digitale Gesch√§ftsmodelle", "keywords": ["KPI-Entwicklung f√ºr digitale Gesch√§ftsmodelle", "Planung", "Forecasting f√ºr digitale Gesch√§ftsmodelle", "Break-Even-Analyse", "Skalierung digitaler Gesch√§ftsmodelle", "Performance-Measurement digitaler Gesch√§ftsmodelle", "Value", "Customer Metrics", "Szenario-Analyse", "Risikobewertung f√ºr digitale Gesch√§ftsmodelle", "Business Case", "Investitionsrechnung f√ºr digitale Gesch√§ftsmodelle", "KPI-Dashboard", "Reporting f√ºr digitale Gesch√§ftsmodelle", "Storytelling f√ºr digitale Gesch√§ftsmodelle", "Prozesskostenrechnung", "Operating Leverage im Controlling digitaler Gesch√§ftsmodelle"]},
            {"id": "startup", "name": "üå± Controlling f√ºr Start-ups", "keywords": ["Wie behalte ich als Gr√ºnder den √úberblick", "Einnahmen", "Ausgaben verstehen", "Mini-GuV f√ºr Start-ups", "Fixkosten erkennen", "reduzieren", "Wo geht mein Geld hin", "Break-even berechnen", "Wann ist mein Unternehmen profitabel", "Finanzplan f√ºrs 1. Jahr", "F√ºr Banken, F√∂rderstellen", "dich selbst", "Umsatzplanung mit wenig Daten", "Szenarien f√ºr unsichere Startphasen", "Einfache Kennzahlen", "Fr√ºhwarnsystem", "Die 3 wichtigsten Zahlen f√ºr dein Business", "Reporting f√ºr Investoren", "F√∂rderstellen", "Monatsbericht in einfach", "Liquidit√§tsplanung ohne Finanzprofi", "90-Tage-Vorschau einfach gemacht", "Vorbereitung auf das erste Mitarbeitergespr√§ch", "Personalkosten", "Planung verstehen"]},
            {"id": "kalkulation_gruender", "name": "üßÆ Kalkulation f√ºr Gr√ºnder", "keywords": ["Einfach kalkulieren", "Was soll ich f√ºr diesen Auftrag verlangen", "Kostenvoranschlag erstellen", "Einfach, verst√§ndlich", "professionell", "Stundensatz richtig berechnen", "Was kostet 1 Stunde wirklich", "Angebotskalkulation mit Material", "Zeit", "F√ºr Handwerk, Dienstleistung, Bau", "Was bleibt √ºbrig", "Deinen Gewinn je Auftrag berechnen", "Preisidee vs. echte Kosten", "Ich dachte, ich verdiene mehr", "Rabatte", "Nachl√§sse richtig kalkulieren", "Was kostet dich ein 10 % Rabatt wirklich", "Preiserh√∂hung erkl√§ren", "begr√ºnden", "F√ºr Stammkunden oder Preisverhandlungen", "Neue Leistungen kalkulieren", "Was kann ich f√ºr mein neues Produkt/Angebot verlangen", "Verkalkuliert", "So berechnest du unerwartete Zusatzkosten richtig", "Auftrag abgebrochen", "Was bleibt dir", "Kannst du geltend machen"]}
        ]
    },
    "Treasury": {
        "icon": "üè¶",
        "themes": [
            {"id": "cash_liquiditaet", "name": "üíµ Cash- & Liquidit√§tsplanung", "keywords": ["Tagesbasierte Liquidit√§tsvorschau", "13-Wochen Rolling Forecast", "Liquidit√§tsplanung auf Wochenbasis", "Szenarioanalyse - Normal, Stress, Worst Case", "Liquidit√§tsplanung", "Liquidit√§tskennzahlen-Dashboard", "Steuerung durch KPIs", "Kapitaldienstf√§higkeitspr√ºfung", "Liquidit√§tsbasierte Analyse", "R√ºckzahlungsf√§higkeit", "Liquidit√§tsauswirkungen einer Investition simulieren", "Kapitalbindung richtig absch√§tzen", "Fr√ºhwarnindikator f√ºr Liquidit√§tsengp√§sse", "automatisiert, flexibel, pr√§ventiv", "Analyse von Zahlungszielen", "Liquidit√§t durch Working Capital Steuerung verbessern", "FX-basierte Liquidit√§tsplanung", "Liquidit√§tsreporting f√ºr Bankgespr√§ch", "bankf√§hig, belastbar, vorausschauend"]},
            {"id": "finanzplanung_budgetierung", "name": "üìà Finanzplanung & Budgetierung", "keywords": ["Treasury-Budget f√ºr das kommende Gesch√§ftsjahr", "Integration der Liquidit√§tsplanung in den Gesamtfinanzplan", "Simulation des Free Cashflows nach Investitionen und Finanzierung", "Szenariobasierte Finanzplanung", "Absicherung gegen Markt- und Planungsunsicherheiten", "Abgleich Forecast vs. Budget", "Abweichungsanalyse und Ursachenbewertung", "Planung der Zinsaufwendungen bei variablen Kreditlinien", "Finanzplanung unter Ber√ºcksichtigung saisonaler Schwankungen", "Working Capital Effekte in die Finanzplanung integrieren", "Treasury-Kostenstellenbudgetierung inkl. TMS und Banken", "Planung der Treasury-KPIs im Jahreszielsystem"]},
            {"id": "finanzierung_kapitalbeschaffung", "name": "üí∞ Finanzierung & Kapitalbeschaffung", "keywords": ["Strukturierung eines optimalen Finanzierungsmixes", "Kapazit√§tsanalyse bestehender Kreditlinien", "Simulationsmodell f√ºr Covenant-Entwicklung", "Liquidit√§tswirksamkeit von Finanzierungsvorhaben simulieren", "Bankf√§higes Finanzierungskonzept erstellen", "Vergleich Kredit- vs. Leasing-Finanzierung", "Vorbereitung auf Refinanzierungsgespr√§che", "Einsatz von F√∂rderkrediten pr√ºfen und strukturieren", "Ermittlung des Fremdkapitalbedarfs aus Investitionsplanung", "Finanzierungsstrategie im Gesch√§ftsmodell verankern"]},
            {"id": "banking_zahlungsverkehr", "name": "üè¶ Banking & Zahlungsverkehr", "keywords": ["Optimierung der Kontostruktur im Unternehmen", "Benchmark der Bankgeb√ºhren und Verhandlungsstrategie", "Entwicklung eines zentralen Zahlungsverkehrskonzepts", "Cash Pooling", "Konzeption und Umsetzungsplan", "Einf√ºhrung einer globalen Zahlungsrichtlinie", "Analyse der Bankbeziehungen und Bankpartnerstrategie", "Instant Payment Integration im Unternehmen", "SEPA- und SWIFT-Konformit√§tscheck f√ºr Zahlungsprozesse", "Zahlungsverkehrssicherheit", "Fraud-Risiken erkennen und minimieren", "Einf√ºhrung eines zentralen Payment Hubs"]},
            {"id": "hedging_absicherung", "name": "üõ°Ô∏è Hedging & Absicherungsstrategien", "keywords": ["Entwicklung einer Hedging-Strategie f√ºr W√§hrungsrisiken", "Simulation der Hedging-Wirkung bei FX-Schwankungen", "Bewertung bestehender Zinsderivate auf Effektivit√§t", "Entscheidungsmatrix f√ºr den Einsatz von FX-Hedging-Instrumenten", "Cashflow-Hedge Accounting vorbereiten", "Rohstoffpreisabsicherung systematisch aufbauen", "Sensitivit√§tsanalyse f√ºr Zinssicherungsbedarf", "Bewertung der Hedge-Quote in FX-Exposures", "Optimale Nutzungsdauer", "Ersatzzeitpunkt", "Aufbau eines internen Hedging-Reportings mit Fr√ºhwarnsystem", "Use Case: Donald Trump und die Strafz√∂lle"]},
            {"id": "compliance_regulatory", "name": "‚öñÔ∏è Compliance & Regulatorische ...", "keywords": ["√úberpr√ºfung der Einhaltung von EMIR- und MiFIR-Pflichten", "Bewertung von Sanktionsrisiken bei internationalen Zahlungspartnern", "Einf√ºhrung eines internen IKS f√ºr Treasury-Prozesse", "Check regulatorischer Anforderungen bei TMS-Auswahl und -Einf√ºhrung", "Meldepflichten bei grenz√ºberschreitenden Finanztransaktionen", "AWV, Z4 etc.", "Bewertung von Treasury-Prozessen auf BAIT-/MaRisk-Konformit√§t", "Entwicklung eines KYC-Checks f√ºr neue Banken oder Zahlungspartner", "Erstellung eines Compliance-Reports f√ºr das Treasury", "Aufbau eines Notfallplans bei regulatorischen Verst√∂√üen oder Datenverlust", "Regulatorische Vorpr√ºfung bei internationalen Cash Pooling-Strukturen"]},
            {"id": "treasury_strategie", "name": "üéØ Treasury Strategie & Governance", "keywords": ["Entwicklung einer konzernweiten Treasury Governance", "Aufbau einer Treasury-Vision", "strategischen Zielbildes", "Festlegung eines Rollen- und Verantwortungsmodells im Treasury", "Strategische Bewertung zentraler vs. dezentraler Treasury-Organisation", "Entwicklung einer Treasury Scorecard mit KPIs und Zielwerten", "Entwicklung eines Treasury Operating Models", "Prozesse, Systeme, Struktur", "Benchmark des Treasury-Reifegrads mit Branchenvergleich", "Entwicklung einer Strategie zur Treasury-Digitalisierung", "Ableitung einer Personalstrategie f√ºr die Treasury-Funktion", "Bewertung der Positionierung des Treasury gegen√ºber CFO, Business", "Banken"]},
            {"id": "finanzierung_kapitalstruktur", "name": "üíº Finanzierung & Kapitalstruktur", "keywords": ["Optimierung des Finanzierungsmix", "kurz-/langfristig", "Vorbereitung auf Kreditgespr√§che und Bankenauswahl", "Liquidit√§tsbasierte Kreditlinienplanung", "Projektstatusbericht", "KPIs, Ampellogik", "Ma√ünahmen", "Entwicklung einer Covenant-Strategie zur Risikosteuerung", "Aufbau einer Kapitalbedarfsplanung f√ºr Wachstums- und Krisenszenarien", "Strategische Planung der Eigen-/Fremdkapitalquote", "Kapitalmarktf√§higkeit und Rating-Vorbereitung", "Finanzierung internationaler Gesellschaften", "Planung und Durchf√ºhrung von Refinanzierungen"]},
            {"id": "esg_sustainable", "name": "üå± ESG & Sustainable Finance im Treasury", "keywords": ["Entwicklung einer ESG-Finanzierungsstrategie im Treasury", "ESG-Kriterien in Kreditvertr√§ge integrieren und steuern", "Green Bond oder Schuldschein strukturiert vorbereiten", "ESG-Scoring im Treasury einf√ºhren und operationalisieren", "Nachhaltigkeitskriterien in Cash- und Bankmanagement verankern", "CSRD-Reporting vorbereiten", "Beitrag des Treasury zur ESG-Berichterstattung", "Entwicklung eines ESG-Treasury-Leitbilds", "Abgleich von ESG-Anforderungen in Kreditvertr√§gen vs. Nachhaltigkeitsstrategie", "Entwicklung eines ESG-Bankenrankings", "Treasury-gest√ºtzte CO‚ÇÇ-Reduktionsstrategie √ºber Finanzinstrumente"]},
            {"id": "treasury_operating", "name": "üîß Treasury Operating Model & ...", "keywords": ["Entwicklung einer Innovationsstrategie f√ºr das Treasury", "Planung", "Forecasting f√ºr digitale Gesch√§ftsmodelle", "Strategische Planung einer API-f√§higen Treasury-Systemarchitektur", "Aufbau einer Treasury-KI-Strategie zur Entscheidungsunterst√ºtzung", "Cyber- und IT-Sicherheitsstrategie f√ºr Treasury-Systeme", "Erstellung einer digitalen Treasury-Roadmap bis 2030", "Einf√ºhrung eines Treasury-KPI- und Benchmarksystems", "Aufbau eines Skill- und Rollenmodells f√ºr das Treasury der Zukunft", "Einf√ºhrung eines Process-Mining-Ansatzes zur Analyse von Treasury-Prozessen", "Positionierung des Treasurys als Innovationstreiber im Unternehmen"]}
        ]
    },
    "CFO": {
        "icon": "üìà",
        "themes": [
            {"id": "strategie_vision", "name": "üéØ Strategie & Vision", "keywords": ["Finanzielle Vision 2030 formulieren", "verankern", "Zukunftsanalyse", "3 Szenarien f√ºr Umsatz, Risiko, Kapitalbedarf", "Werttreiber-Modell des Unternehmens entwickeln", "Strategische Fr√ºhindikatoren", "CFO-Kennzahlensystem", "CFO-Radar: Strategiegespr√§che intelligent vorbereiten", "Portfolio-Readiness: Gesch√§ftsfelder strategisch bewerten", "CFO-Strategiepapier: 3-Jahres-Roadmap f√ºr Finance", "Wachstumsarchitektur mit Finanzlogik unterlegen", "Strategie-Kompetenzmodell f√ºr das CFO-Team aufbauen", "CFO-Zielbild", "F√ºhrungsrolle der Zukunft"]},
            {"id": "global_strategy", "name": "üåç Global Strategy", "keywords": ["L√§nderscoring-Modell zur internationalen Expansion", "Break-even-Analyse f√ºr internationale Rollouts", "Rollout-Reifegradmodell f√ºr internationale M√§rkte", "Go-to-Market-Modell f√ºr internationale Expansion", "KPI-Mastermodell f√ºr internationale Expansion", "Expansions-Risikomodell f√ºr internationale M√§rkte", "Insight Asia 2025 - Geopolitisch-strategisch", "Insight India 2025 - Standortbewertung- und Investitionsbewertung", "Wachstumsstrategie systematisch bewerten und steuern", "Use Case - Globale Marktexpansion"]},
            {"id": "ki_entscheidung", "name": "ü§ñ KI & Entscheidungsintelligenz", "keywords": ["Forecasting mit generativer KI strukturieren", "CFO Control Tower", "Echtzeitsteuerung mit KI-Modellen", "KI-Readiness-Check im CFO-Bereich", "KI-gest√ºtzte Investitionsbewertung", "ROI-Prognose", "Prompt-Design f√ºr Finanzabteilungen standardisieren", "Use Case-Matrix f√ºr KI im CFO-Bereich", "Explainable AI", "CFO-Verst√§ndnis", "Regulatorik absichern", "KI im Monats- und Quartalsreporting einbinden", "Zusammenarbeit von CFO", "KI-Produktteam strukturieren", "Entscheidungsarchitektur f√ºr CFOs mit KI"]},
            {"id": "transformation_operating", "name": "üîÑ Transformation & Operating Model", "keywords": ["Target Operating Model (TOM) CFO-kompatibel ausgestalten", "CFO-Steuerungsmodell f√ºr Transformationen entwickeln", "Shared Services Operating Model der n√§chsten Generation entwickeln", "Rollenver√§nderung im CFO-Bereich gestalten", "Transformationsprojekte systematisch priorisieren", "Agiles Operating Model im CFO-Bereich entwickeln", "Kostenf√ºhrungsmodell entwickeln", "ohne Qualit√§tsverlust", "Transformation Enablement Scorecard entwickeln", "Governance-Struktur f√ºr Transformationen entwickeln", "Finance Shared Services der Zukunft entwickeln", "The Leader in ESG Change Management"]},
            {"id": "digitale_transformation", "name": "üíª Digitale Transformation", "keywords": ["Digitale Vision als CFO mitgestalten", "Finanzielle Bewertung strategisch relevanter Digital-Probleme", "Business Case SSC", "Business Case: 4 Validierungsstufen", "Steuerungsmodell f√ºr skalierbares digitales Wachstum", "Investitionsstrategie f√ºr Tech, Talent", "Kulturaufbau", "Transformation Roadmap erstellen", "Talent Bench aufbauen", "Neues Operating Model adaptieren", "Technologie-Infrastruktur f√ºr Innovation aufbauen", "Datenorganisation", "-kultur etablieren", "Adoption", "Skalierung absichern"]},
            {"id": "finance_excellence", "name": "‚≠ê Finance Excellence & Steuerung", "keywords": ["Finance Operating Model bewerten und weiterentwickeln", "Shared Services vs. dezentrale Steuerung", "Modell bewerten und ausrichten", "Reifegradmodell f√ºr den CFO-Bereich entwickeln", "Performance Management System aufbauen", "Steuerungsarchitektur f√ºr Business Partnering im Controlling entwickeln", "Planungsprozess auf Effektivit√§t", "Relevanz pr√ºfen", "Effizienzpotenziale im Finanzbereich identifizieren und heben", "Kostenrechnungssysteme auf Aktualit√§t", "Steuerungslogik pr√ºfen", "Governance-", "Kontrollsystem im CFO-Bereich st√§rken", "Exzellenzinitiative im CFO-Team entwickeln"]},
            {"id": "finanzierung_kapitalstruktur_cfo", "name": "üíº Finanzierung & Kapitalstruktur", "keywords": ["Kapitalstruktur analysieren", "Zielstruktur definieren", "Finanzierungsstrategie kurz- und langfristig entwickeln", "Kreditportfolio", "Bankenstrategie steuern", "Leverage-Ratio", "Zinsdeckungsgrad im Szenario pr√ºfen", "Alternative Finanzierungsquellen bewerten", "Cash Conversion Cycle", "Working Capital gezielt steuern", "Finanzierung von M&A-Transaktionen strukturieren", "Eigenkapitalinstrumente f√ºr Wachstumsphasen gestalten", "Zinsmanagement", "Refinanzierungsstrategie aktiv gestalten", "Kapitaldienstf√§higkeit im Planungsmodell simulieren"]},
            {"id": "ma_beteiligung", "name": "ü§ù M&A & Beteiligungsstrategie", "keywords": ["Ist der geplante Deal strategisch kapitalgerecht", "Freigabeentscheidung f√ºr einen M&A-Deal", "Ja oder Nein", "Beteiligungsstrategie auf Gruppenebene entwickeln", "Zielrendite und Wertsteigerungshebel bei Beteiligungen definieren", "Welche Rolle spielt der CFO in M&A-Freigabeprozess", "Werttreiberlogik in Buy-&-Build-Strategien bewerten", "Vorschlag f√ºr Divestment oder Carve-Out strategisch bewerten", "Post-Merger-Zielsteuerung aus CFO-Sicht definieren", "Beteiligung in der Krise", "Sanierungsentscheidung treffen", "Szenariobasierte Bewertung der M&A-Finanzierung", "Kapitalbindung"]},
            {"id": "strategisches_kostenmanagement", "name": "üìä Strategisches Kostenmanagement", "keywords": ["Strategische Prinzipien f√ºr ein gruppenweites Effizienzprogramm", "Versteckte Kosten- und Komplexit√§tstreiber identifizieren", "Zero-Based Budgeting (ZBB) intelligent umsetzen", "ohne operative L√§hmung", "KPI-Logik f√ºr Cost-Reduction-Initiativen aufsetzen", "Kostensenkung bewerten: Wirkung, Nachhaltigkeit, Nebenwirkung", "Target Operating Model (TOM) auf Kostenlogik pr√ºfen", "Kostenbewusstsein in den Business Units verankern", "ohne Micromanagement", "Cost Transformation Program aufsetzen", "Struktur, Rollen, KPI", "Synergieziele aus M&A in der GuV verankern", "nachhalten", "Capex-Einsparungen entscheidungsf√§hig aufbereiten"]},
            {"id": "capital_allocation", "name": "üí° Capital Allocation & Investment Logic", "keywords": ["Capital Allocation Strategy entwickeln", "Wachstum, Risiko und Rendite balancieren", "Investitionsprojekte vergleichbar bewerten und priorisieren", "CFO-Freigabe im Investment Committee definieren", "Cash-zu-Wachstum-Logik optimieren", "Capex, M&A, Dividende, Buybacks", "Innovations-", "Technologieinvestitionen bewerten", "aus CFO-Perspektive", "Scoring-Modell f√ºr Investitionsentscheidungen entwickeln", "Kapitalallokation √ºber Regionen", "Business Units steuern", "Capital Turnover", "Asset Efficiency steuern", "Wirkung auf RoCE", "Wertsch√∂pfung verstehen", "Post-Investment Review aufsetzen", "Wirkung und Lernprozesse sicherstellen", "Investment Governance verankern", "Entscheidungsrahmen und Reifegrad sichern"]},
            {"id": "geopolitische_resilienz", "name": "üåç Geopolitische Resilienz & ...", "keywords": ["Integriertes Enterprise Risk Management (ERM)", "Risikosteuerung im Forecast-", "Planungsprozess verankern", "Cyber-Risiken finanziell bewerten und CFO-wirksam steuern", "Technologische Abh√§ngigkeit", "Legacy-Risiken bewerten", "Regulatorische ESG-Risiken systematisch identifizieren", "finanziell bewerten", "Reputationsrisiken fr√ºhzeitig identifizieren", "absichern", "ESG-Risikobewertung in Investitionsentscheidungen verankern", "Standortrisiken", "Handelsabh√§ngigkeiten systematisch bewerten", "Geopolitische Szenarien in der Finanzplanung ber√ºcksichtigen", "Sanktions-", "Exportkontrollrisiken strategisch absichern", "Zinsrisiken erkennen, bewerten", "strategisch steuern"]}
        ]
    },
    "M&A": {
        "icon": "ü§ù",
        "themes": [
            {"id": "prozesse_rollen", "name": "‚öôÔ∏è M&A Prozesse & Rollen", "keywords": ["M&A Prozess√ºberblick f√ºr die Sell-Side", "M&A Prozess√ºberblick f√ºr die Buy-Side", "Bieterverfahren vs. Exklusivprozess", "Sell-Side Perspektive", "Bieterverfahren vs. Exklusivprozess", "Buy-Side Perspektive", "Erstellung einer M&A Stakeholder Map", "Erstellung einer typischen M&A-Transaktionstimeline", "√úbersicht der Beraterrollen im M&A-Prozess", "Ma√ünahmen zur Transaktionsvorbereitung", "Sell-Side"]},
            {"id": "gestaltungsformen", "name": "üìã Gestaltungsformen und ...", "keywords": ["Share Deal √úberblick", "Asset Deal √úberblick", "Kombinationsmodelle: Share Deal + Asset Deal", "Carve-Outs", "Internationale M&A-Transaktionen", "Cross-Border Deals", "Strategische Investoren vs. Finanzinvestoren", "Unterschiede und Auswirkungen", "Public M&A vs. Private M&A", "Unterschiede, Ablauf und Besonderheiten", "Besondere Transaktionsformen: MBO, MBI, Joint Venture, Merger"]},
            {"id": "pre_deal", "name": "üéØ Pre-Deal Phase", "keywords": ["Durchf√ºhrung einer professionellen Marktanalyse", "Erstellung einer Target-Liste und Target Screening", "Deal Sourcing: Strategien und Kan√§le f√ºr die Identifikation von Targets", "Bieterverfahren vs. Exklusivprozess", "Buy-Side Perspektive", "Erstansprache potenzieller Targets", "Erstellung eines Teasers und Information Memorandum", "Erstellung eines NDA", "Non-Disclosure Agreement", "Erstellung eines Letter of Intent", "LOI", "Ma√ünahmen zur Transaktionsvorbereitung", "Sell-Side"]},
            {"id": "strategic_dd", "name": "üîç Strategic FIT Due Diligence", "keywords": ["Notwendigkeit einer Strategic Due Diligence", "Inhalte einer Strategic Due Diligence", "Ablauf einer Strategic Due Diligence", "Ermittlung und Quantifizierung von Synergiepotenzialen", "Advanced Prompt", "Synergie Scoring Modell / Business Model Canvas f√ºr Strategic Due Diligence"]},
            {"id": "commercial_dd", "name": "üíº Commercial FIT Due Diligence", "keywords": ["Grundlagen", "Zielsetzung der Commercial DD", "Markt- und Branchenanalyse", "Kunden- und Wettbewerbsanalyse", "Gesch√§ftsmodellanalyse", "Positionierung", "Validierung der Business-Planung", "Risikoanalyse", "Verkn√ºpfung der CDD mit der Unternehmensbewertung"]},
            {"id": "financial_dd", "name": "üí∞ Financial Due Diligence", "keywords": ["Erstellung einer vollst√§ndigen Financial Due Diligence Checkliste", "Durchf√ºhrung einer Quality of Earnings", "QoE", "Analyse", "Normalisierung von Ertr√§gen und Aufwendungen", "Durchf√ºhrung einer Working Capital Analyse", "Durchf√ºhrung einer Net Debt Analyse", "Analyse und Plausibilisierung des Business Plans", "Red Flag Analyse", "Aufbau eines vollst√§ndigen Financial Due Diligence Reports", "Case-Prompt: Quality of Earnings Analyse mit konkreten Zahlen"]},
            {"id": "tax_dd", "name": "üìä Tax Due Diligence", "keywords": ["Erstellung einer vollst√§ndigen Tax Due Diligence Checkliste", "Identifikation typischer steuerlicher Risiken", "Red Flags", "K√∂rperschaftsteuer Due Diligence", "Gewerbesteuer Due Diligence", "Umsatzsteuer Due Diligence", "Lohnsteuer Due Diligence", "Tax Compliance", "Betriebspr√ºfungsrisiken", "Internationale Steuerfragen in der Tax Due Diligence", "Steuerliche Themen im SPA"]},
            {"id": "legal_dd", "name": "‚öñÔ∏è Legal Due Diligence", "keywords": ["Erstellung einer vollst√§ndigen Legal Due Diligence Checkliste", "Gesellschaftsrechtliche Pr√ºfung", "Pr√ºfung gewerblicher Schutzrechte", "Miet-, Pacht- und Leasingvertr√§ge", "Vertrags- und Vertriebsrecht", "Arbeitsrechtliche Due Diligence", "Compliance, Litigation", "beh√∂rdliche Verfahren", "Change-of-Control-Klauseln", "M&A-relevante Vertragsregelungen", "Red Flag Analyse", "Advanced Prompt", "Software-", "Quellcode-Eigentumsanalyse", "Advanced Prompt", "Open Source", "Compliance"]},
            {"id": "bewertung", "name": "üìà Unternehmensbewertung", "keywords": ["Unternehmensbewertung nach IDW S1", "Plausibilisierung der Planungsrechnung", "Unternehmensbewertung mittels DCF-Verfahren", "Durchf√ºhrung einer Quality of Earnings", "QoE", "Analyse", "Durchf√ºhrung einer Working Capital Analyse", "Durchf√ºhrung einer Net Debt Analyse", "Analyse und Plausibilisierung des Business Plans", "Red Flag Analyse", "Bewertungsfallen", "Aufbau eines vollst√§ndigen Financial Due Diligence Reports", "Case prompt", "Sensitivit√§tsanalyse zur Unternehmensbewertung", "Case prompt", "Unternehmensbewertung", "DCF-Entity Approach"]},
            {"id": "kaufvertrag", "name": "üìÑ Kaufvertragsgestaltung", "keywords": ["Erstellung eines vollst√§ndigen SPA-Grundger√ºsts", "Kaufpreisgestaltung im SPA", "Garantien", "Freistellungen", "Warranties", "Indemnities", "Covenants", "Pre-Closing-Verpflichtungen", "Closing Conditions", "Vollzugsbedingungen im SPA", "Haftungsregelungen im SPA", "Haftungsh√∂he, Dauer, Cap, Basket", "Streitbeilegung", "Gerichtsstand", "Schiedsgericht, ordentliche Gerichtsbarkeit, Rechtswahl", "Strukturierung einer W&I Insurance im M&A-Prozess"]},
            {"id": "pmi", "name": "üîÑ Post-Merger-Integration", "keywords": ["Grundlagen und Zielsetzung", "PMI", "PMI-Planung und Governance", "Entwicklung der Integrationsstrategie", "Synergieplanung und Synergietracking", "Kommunikationsstrategie", "intern", "extern", "Integration der Organisation", "HR, Kultur, Change-Management", "Operative Integration", "Prozesse, IT, Controlling, Einkauf, Vertrieb", "Advanced M&A Controlling", "Monitoring inkl. Synergietracking, KPI-System", "Risiko-Reporting", "Lessons Learned", "Optimierung nach der PMI"]},
            {"id": "finanzierung_ma", "name": "üíµ Finanzierung", "keywords": ["Strukturierung der Akquisitionsfinanzierung", "Debt / Equity", "Bestimmung der optimalen Eigenkapitalquote und Leverage im M&A-Deal", "Strukturierung von Senior Debt, Mezzanine und Equity im Rahmen der Akquisitionsfinanzierung", "Covenants und Finanzierungsbedingungen im M&A-Deal", "Planung der Schuldendienstf√§higkeit und Cashflow-Sicherheit", "Simulation von Leverage-Effekten inkl. Eigenkapitalrendite und Value Creation", "Bankprozess", "Debt Advisory", "Banken, Unterlagen, Verhandlungen", "Vertragswerke im Finanzierungsprozess", "Term Sheet, Kreditvertrag, Intercreditor Agreement", "Besonderheiten bei Private Equity, Leveraged Buy-Outs", "LBO", "Management Buy-Outs", "MBO", "Integration der Debt-Finanzierung in SPA und Unternehmensbewertung", "Post-Deal-Finanzierung und Refinanzierung", "Working Capital Facilities, Umschuldung, Optimierung"]},
            {"id": "distressed", "name": "üÜò Distressed M&A", "keywords": ["Besonderheiten und Grundz√ºge von Distressed M&A", "Ablauf einer typischen Distressed M&A Transaktion", "Pr√ºfung der insolvenzrechtlichen Situation", "Kaufgegenstand", "Deal-Struktur", "Erstellung einer M&A Stakeholder Map", "Digital Due Diligence in der Krise", "Schutzmechanismen im Kaufvertrag bei Distressed M&A", "Kaufpreisfindung und Earn-Outs im Distressed M&A", "Finanzierung von Distressed M&A-Transaktionen", "Stakeholder-Management im Distressed M&A", "Arbeitsrecht und Personal im Distressed M&A", "Betriebs√ºbergang, ¬ß 613a BGB, Sozialplan", "Post-Deal-Phase im Distressed M&A"]},
            {"id": "vc_growth", "name": "üöÄ Venture Capital & Growth Equity", "keywords": ["Grundlagen", "Besonderheiten von VC- und Growth Equity-Transaktionen", "Deal-Strukturen im VC", "Growth Equity", "Unternehmensbewertung in VC", "Due Diligence im VC-Umfeld", "Financial, Legal, IP, Commercial", "Term Sheet in VC-Deals", "Cap Table Management", "Verw√§sserung", "vor und nach der Finanzierungsrunde", "Gesellschaftervereinbarung", "Investor Rights Agreement", "Exit-Szenarien und Beteiligungscontrolling", "IPO, Trade Sale, Secondary", "Growth Equity Besonderheiten", "Praxisfall: Investment in ein SaaS-Start-up"]},
            {"id": "verhandlung", "name": "ü§ù Verhandlungsf√ºhrung & Deal Tactics", "keywords": ["Verhandlungsvorbereitung", "Zieldefinition, BATNA, Verhandlungsstrategie", "Integrative vs. Distributive Verhandlungsans√§tze wie z.B. Win-Win vs. Harvard-Konzept angewendet", "Verhandlungstaktiken", "Typische Verhaltensweisen von K√§ufer und Verk√§ufer", "Priorisierung der Verhandlungsgegenst√§nde", "inkl. Konfliktintensit√§tsmatrix", "Nutzung von Verhandlungsmacht, Deal Timing und taktischen Deadlines", "Kommunikations- und Verhandlungstechniken", "Signale, Sprache, K√∂rpersprache", "Buy-Side Verhandlungstaktik", "Optimale Vorbereitung und Umsetzung", "Sell-Side Verhandlungstaktik", "Deal Protection und Kaufpreismaximierung", "Umgang mit schwierigen Verhandlungen und Deadlocks", "Negotiation Playbook", "Checklisten, Templates", "Deal Scoring"]}
        ]
    },
    "Bilanzbuchhalter": {
                "icon": "üìö",
                "themes": [
                    {"id": "zwecke_grundsaetze", "name": "üìã Zwecke und Grunds√§tze der ...", "keywords": ["Zwecke des Jahresabschlusses", "Grundsatz der Richtigkeit", "Grundsatz der Vergleichbarkeit", "Grundsatz der Klarheit", "Grundsatz der Vollst√§ndigkeit", "Bilanzstichtagsprinzip ‚Äì Werterhellend", "Periodisierungsprinzip", "Realisationsprinzip", "Imparit√§tsprinzip", "Vorsichtsprinzip"]},
                    {"id": "allgemeine_ansatz", "name": "‚öñÔ∏è Allgemeine Ansatzregeln", "keywords": ["Aktivierungsf√§higkeit nach HGB ‚Äì abstrakt & konkret", "Aktivierungsverbot nach ¬ß 248 Abs. 2", "Aktivierungswahlrechte ‚Äì Entwicklungskosten und Disagio", "Aktivierungsgebote bei Nicht-Verm√∂gensgegenst√§nden ‚Äì z.B. RAP", "Zurechnung von Verm√∂gensgegenst√§nden ‚Äì wirtschaftliches vs. rechtliches", "Passivierungsf√§higkeit ‚Äì Drei Kriterien", "Abgrenzung: R√ºckstellung oder Eventualverbindlichkeit", "Ansatzgrunds√§tze in der Steuerbilanz ‚Äì Ma√ügeblichkeitsprinzip", "Ansatzvorschriften nach IFRS ‚Äì Unterschiede zu HGB"]},
                    {"id": "allgemeine_bewertung", "name": "üí∞ Allgemeine Bewertungsregeln", "keywords": ["Grundprinzipien der Bewertung ‚Äì √úberblick", "Zugangsbewertung von Verm√∂gensgegenst√§nden ‚Äì Anschaffung", "Folgebewertung ‚Äì Niederstwertprinzip und Zuschreibungspflicht", "Bewertung von Schulden ‚Äì Erf√ºllungsbetrag", "Bewertungsvereinfachungsverfahren ‚Äì FIFO, LIFO", "Bewertungseinheiten und Sicherungsbeziehungen ‚Äì ¬ß 254", "W√§hrungsumrechnung bei Bilanzansatz ‚Äì ¬ß 256a", "IFRS-Bewertungskonzepte im Vergleich", "Wertaufhellung vs. Wertbegr√ºndung ‚Äì Bilanzstichtagsprinzip richtig"]},
                    {"id": "anlagevermoegen", "name": "üè≠ Bilanzierung des Anlageverm√∂gens", "keywords": ["Aktivierung von Sachanlagen ‚Äì Anschaffungsnebenkosten & nachtr√§gliche AK", "Nachtr√§gliche Anschaffungskosten ‚Äì Erweiterungen und Erneuerungen", "Erweiterungen und Erneuerungen an Anlagen", "Abgrenzung aktivierungspflichtiger, -f√§higer und -verbotener Posten", "Aktivierung selbst erstellter immaterieller Verm√∂genswerte bei teilweise", "Abgrenzung Anlageverm√∂gen vs. Umlaufverm√∂gen ‚Äì Zurechnung", "Zurechnung von Wirtschaftsg√ºtern bei abweichender zivilrechtlicher", "Bilanzierung von Anlagen im Bau", "Bilanzierung geringwertiger Wirtschaftsg√ºter ‚Äì GWG", "Origin√§rer Gesch√§fts- oder Firmenwert"]},
                    {"id": "vorratsvermoegen", "name": "üì¶ Bilanzierung des Vorratsverm√∂gens", "keywords": ["Definition & Abgrenzung: Was geh√∂rt zum Vorratsverm√∂gen", "Zugangsbewertung von Vorr√§ten gem√§√ü ¬ß 255 Abs", "Folgebewertung von Vorr√§ten nach dem Niederstwertprinzip ‚Äì ¬ß 253 Abs. 4", "Bewertungsvereinfachungsverfahren bei Vorr√§ten ‚Äì FIFO", "Teilwertabschreibung bei Vorr√§ten ‚Äì steuerliche Bewertung", "Bewertung von Roh-, Hilfs- und Betriebsstoffen ‚Äì Zugangs", "Bewertung unfertiger Erzeugnisse ‚Äì Herstellungskosten", "Bewertung fertiger Erzeugnisse ‚Äì Niederstwertprinzip", "Bewertung von Handelswaren ‚Äì Strenges Niederstwertprinzip", "Bewertung des Vorratsverm√∂gens nach IFRS", "Bewertung des Vorratsverm√∂gens nach US GAAP"]},
                    {"id": "forderungen", "name": "üìÑ Bilanzierung der Forderungen", "keywords": ["Bilanzierung von Forderungen aus Lieferungen und Leistungen nach HGB", "Zweifelhafte Forderungen: Teilwertabschreibung und Pauschalwertberichtigung", "Pauschalwertberichtigung auf Forderungen nach HGB und ESTG", "Bilanzierung uneinbringlicher Forderungen ‚Äì Vollwertabschreibung", "Pauschalwertberichtigung auf Forderungen ‚Äì Einzel- & Gruppenrisiken", "Umsatzsteuerliche Korrekturen bei uneinbringlichen Forderungen ‚Äì ¬ß 17 UStG", "Bilanzierung von Forderungen nach IFRS ‚Äì Klassifikation", "Bilanzierung nach IFRS 9 ‚Äì Expected Credit Loss Model"]},
                    {"id": "finanzinstrumente", "name": "üíº Bilanzierungen von Finanzinstrumenten", "keywords": ["Klassifizierung von Finanzinstrumenten (HGB)", "Bewertung b√∂rsennotierter Wertpapiere (Umlaufverm√∂gen, HGB)", "Bilanzierung nicht b√∂rsennotierter Beteiligungen (Finanzanlageverm√∂gen, HGB)", "Zuschreibungen bei Wertaufholung (¬ß 253 Abs. 5 HGB)", "Abgrenzung derivativer Finanzinstrumente (z.B. Optionen, Swaps, Futures) ‚Äì Hedging", "Hedging & Bewertung von Sicherungsgesch√§ften nach HGB", "Verkauf und Ausbuchung von Finanzinstrumenten (HGB)", "Bilanzierung von Finanzinstrumenten bei Kreditinstituten (RechKredV)", "Vergleich HGB vs. IFRS bei der Bilanzierung von Finanzinstrumenten", "Vergleich HGB vs. US GAAP bei der Bilanzierung von Finanzinstrumenten"]},
                    {"id": "eigenkapital", "name": "üíé Bilanzierung des Eigenkapitals", "keywords": ["Funktion, Gliederung und Bedeutung des Eigenkapitals nach HGB", "Bilanzierung des gezeichneten Kapitals ‚Äì Zugang, Bewertung, Handelsregistereintrag", "Ausstehende Einlagen auf das gezeichnete Kapital nach ¬ß 272 Abs", "Kapitalerh√∂hung ‚Äì Bilanzierung des gezeichneten Kapitals und der Kapitalr√ºcklage", "Kapitalherabsetzung ‚Äì Bilanzielle Behandlung und Ausweis", "Kapitalzuschuss nach ¬ß 272 Abs. 2 HGB ‚Äì Bilanzierung", "Gewinnr√ºcklagen nach ¬ß 272 Abs. 3-5 HGB ‚Äì Bildung", "Gewinn-/Verlustvortrag ‚Äì Bilanzierung und Ausweis in Jahresabschluss", "Jahres√ºberschuss / Jahresfehlbetrag ‚Äì Ausweis, Verrechnung", "Sonder- & Erg√§nzungskapitalkonten bei Personengesellschaften ‚Äì Bilanzierung", "Inkongruente Gewinnaussch√ºttung ‚Äì Steuerlich zul√§ssige Gestaltung", "Disquotalen Einzahlung in die Kapitalr√ºcklage bei GmbHs"]},
                    {"id": "verbindlichkeiten", "name": "üîó Bilanzierung von Verbindlichkeiten", "keywords": ["Begriff und Arten von Verbindlichkeiten ‚Äì Abgrenzung, Systematik, Ausweis", "Ansatz und Bewertung von Verbindlichkeiten ‚Äì Grunds√§tze nach ¬ß 253 HGB", "Verbindlichkeiten mit Differenz zwischen Auszahlung und R√ºckzahlung ‚Äì Abzinsung", "Unverzinsliche Verbindlichkeiten aus Rentenverpflichtungen ‚Äì Barwert", "Verbindlichkeiten mit Skonto ‚Äì Bewertung zum Erf√ºllungsbetrag", "Fremdw√§hrungsverbindlichkeiten ‚Äì Zugang, Umrechnung & Bewertung nach ¬ß 256a", "Bilanzierung von Verbindlichkeiten nach IFRS ‚Äì Klassifikation, Bewertung", "Verbindlichkeiten nach US GAAP ‚Äì Klassifikation, Bewertung, Debt Modification", "Verbindlichkeiten im Vergleich ‚Äì HGB, IFRS & US GAAP"]},
                    {"id": "rueckstellungen", "name": "üìä Bilanzierung der R√ºckstellungen", "keywords": ["R√ºckstellungen ‚Äì Begriff, Zweck & Abgrenzung zu Verbindlichkeiten ‚Äì ¬ß 249 HGB", "R√ºckstellungen in der Steuerbilanz ‚Äì Ma√ügeblichkeit & R√ºckstellungsverbot", "R√ºckstellungen f√ºr ungewisse Verbindlichkeiten ‚Äì Ansatz, Nachweis", "R√ºckstellungen f√ºr unterlassene Instandhaltung und Abraumbeseitigung", "R√ºckstellungen f√ºr Gew√§hrleistungen ohne rechtliche Verpflichtungen und Kulanz", "R√ºckstellungen f√ºr Steuern", "Bewertung von R√ºckstellungen ‚Äì Erf√ºllungsbetrag, Abzinsung und Erfahrungswerte ‚Äì ¬ß 253", "Bilanzierung von Drohverlustr√ºckstellungen bei schwebenden Gesch√§ften", "R√ºckstellungen f√ºr Pensionen und √§hnliche Verpflichtungen", "R√ºckstellungen f√ºr Altersversorgungsverpflichtungen ‚Äì BilMoG-Regeln & Abzinsung", "Anhangangaben zu R√ºckstellungen gem√§√ü ¬ß 285 Nr. 12 HGB", "R√ºckstellungen nach IFRS (IAS 37) ‚Äì Ansatz, Bewertung", "R√ºckstellungen nach US GAAP (ASC 450) ‚Äì Contingencies & Probabilities", "Vergleich R√ºckstellungen HGB ‚Äì IFRS ‚Äì US GAAP", "R√ºckstellungen f√ºr Dienstjubil√§en"]},
                    {"id": "besondere_posten", "name": "üìå Besondere Bilanzposten", "keywords": ["Begriff & Funktion von Rechnungsabgrenzungsposten ‚Äì ¬ß 250 HGB", "Active Rechnungsabgrenzungsposten ‚Äì Voraussetzungen, Abgrenzung, Beispiele", "Passive Rechnungsabgrenzungsposten ‚Äì Voraussetzungen, Besonderheiten", "Abgrenzung RAP zu Verbindlichkeiten & R√ºckstellungen", "Latente Steuern ‚Äì Grundlagen & gesetzliche Vorgaben ‚Äì ¬ß 274 HGB", "Active latente Steuern ‚Äì Ansatz, Bewertung, Verlustvortr√§ge", "Passive latente Steuern ‚Äì Entstehung, Abgrenzung, Beispiel", "Latente Steuern im IFRS-Abschluss (IAS 12)", "Eventualverbindlichkeiten & Haftungsverh√§ltnisse ‚Äì ¬ß 251 HGB", "B√ºrgschaften, Patronatserkl√§rungen, Sicherheiten ‚Äì Bilanzierung und Offenlegung", "Angabepflichten bei nicht bilanzierungsf√§higen Verpflichtungen"]},
                    {"id": "guv", "name": "üìà Gewinn- und Verlustrechnung", "keywords": ["Aufbau, Gliederung und Bedeutung der GuV nach ¬ß 275 HGB", "Gliederung der Gesamtkosten- und Umsatzkostenverfahren ‚Äì Wahlrecht", "Umsatzerl√∂se nach ¬ß 277 Abs. 1 HGB und IFRS 15", "Bestandsver√§nderungen und aktivierte Eigenleistungen ‚Äì ¬ß 275 Abs. 2 Nr. 2-3", "Sonstige betriebliche Ertr√§ge & Aufwendungen", "Personalaufwand ‚Äì ¬ß 275 Abs. 2 Nr. 6 HGB", "Abschreibungen auf immaterielle Verm√∂gensgegenst√§nde und Sachanlagen ‚Äì ¬ß 275 Abs. 2", "Ertr√§ge und Aufwendungen aus Beteiligungen, Wertpapieren und Finanzinstrumenten", "Zinsertr√§ge und Zinsaufwendungen ‚Äì handelsrechtlicher Ausweis und IFRS", "Ergebnis aus W√§hrungsumrechnung und Kurssicherung ‚Äì GuV-Ausweis", "Au√üerordentliche Ertr√§ge & Aufwendungen ‚Äì handelsrechtliche Bedeutung", "Jahres√ºberschuss und Bilanzgewinn ‚Äì Ableitung, Einflussgr√∂√üen", "Ergebnisverwendung im Einzelabschluss vs. Konzernabschluss"]},
                    {"id": "anhang", "name": "üìù Anhang", "keywords": ["Zweck, Funktion und Struktur des Anhangs ‚Äì ¬ß¬ß 284‚Äì285 HGB", "Bilanzierungs- und Bewertungsmethoden im Anhang ‚Äì ¬ß 284 Abs. 2 HGB", "Verbindlichkeiten, Sicherheiten und Restlaufzeiten im Anhang ‚Äì ¬ß 285 Nr. 1-3", "Anhangangaben zu Anteilseignern, Beteiligungen und Organen ‚Äì ¬ß 285 Nr. 10-11a", "Angaben zur Ergebnisverwendung und Aussch√ºttung im Anhang ‚Äì ¬ß 285 Nr. 13", "Freiwillige Angaben & Best Practices im Anhang ‚Äì z.B. ESG", "Gr√∂√üenabh√§ngige Erleichterungen ‚Äì Wegfasslisten nach ¬ß 288 HGB", "Haftungsverh√§ltnisse & Eventualverbindlichkeiten ‚Äì ¬ß 251 HGB & ¬ß 285 Nr. 3", "Nachtragsberichterstattung ‚Äì Ereignisse nach dem Bilanzstichtag ‚Äì ¬ß 285 Abs. 33", "Angaben zu Beteiligungen & Tochterunternehmen ‚Äì ¬ß 285 Nr. 11 & ¬ß 313", "Exklusiv: Vollst√§ndiger Anhang"]},
                    {"id": "lagebericht", "name": "üìÑ Lagebericht", "keywords": ["Grundlagen des Lageberichts: Funktionen, Zielsetzung & gesetzliche Grundlagen ‚Äì ¬ß 289", "Inhalt des Lageberichts: Pflichtbestandteile nach ¬ß 289 Abs. 1 HGB", "Forschungs- und Entwicklungsaktivit√§ten im Lagebericht ‚Äì ¬ß 289 Abs. 2 Nr. 1", "Darstellung des Gesch√§ftsverlaufs im Lagebericht ‚Äì ¬ß 289 Abs. 1 HGB", "Prognose-, Chancen- und Risikobericht ‚Äì ¬ß 289 Abs. 1 S. 4 HGB inkl. Ausblick", "Risikomanagementsystem & IKS im Lagebericht ‚Äì ¬ß 289 Abs. 4 HGB", "Darstellung der Verm√∂gens-, Finanz- und Ertragslage (VFE-Lage)", "Darstellung der Ertragslage im Lagebericht gem√§√ü ¬ß 289 HGB und DRS 20", "Nachtragsbericht im Lagebericht ‚Äì Ereignisse nach dem Bilanzstichtag ‚Äì ¬ß 285 Nr. 33", "Finanzielle Leistungsindikatoren im Lagebericht ‚Äì ¬ß 289 Abs. 1 S. 4 HGB", "Nichtfinanzielle Leistungsindikatoren im Lagebericht ‚Äì ¬ß 289 Abs. 3 HGB", "Erkl√§rung zur Unternehmensf√ºhrung ‚Äì ¬ß 289f HGB", "Gesamtbild und Vollst√§ndigkeitserkl√§rung im Lagebericht"]},
                    {"id": "kapitalflussrechnung", "name": "üíµ Kapitalflussrechnung", "keywords": ["Zweck und Rechtsgrundlagen der Kapitalflussrechnung nach HGB ‚Äì ¬ß¬ß 264, 297 HGB und IFRS", "Grundstruktur und Gliederung der Kapitalflussrechnung nach DRS 21 und IAS 7", "Cashflow aus laufender Gesch√§ftst√§tigkeit", "Cashflow aus Investitionst√§tigkeit", "Cashflow aus Finanzierungst√§tigkeit", "Ableitung der Kapitalflussrechnung aus Bilanz und GuV", "Definition & Abgrenzung Finanzmittelfonds", "Kapitalflussrechnung im Konzern", "Kapitalflussrechnung nach IFRS (IAS 7) ‚Äì Pflichten, Gliederung", "Sonderfragen in der Kapitalflussrechnung ‚Äì Leasing, Factoring", "Pr√ºfung und Plausibilisierung der Kapitalflussrechnung", "Erstellung einer vollst√§ndigen Kapitalflussrechnung durch die KI"]},
                ]
            },
    "Fachanwalt Gesellschaftsrecht": {
        "icon": "‚öñÔ∏è",
        "themes": [
            {"id": "rechtsformen_haftung", "name": "‚öñÔ∏è Rechtsformen & Haftungsstruktur", "keywords": ["Vergleich der Gesellschaftsformen", "Haftung, Gr√ºndung", "Investorenf√§higkeit", "Rechtsform", "Bonit√§t", "wie die Wahl der Gesellschaftsform die Finanzierung beeinflusst", "Was ist eine GbR", "und was muss ich als Nichtjurist:in beachten", "Innen- und Au√üenverh√§ltnis in der GbR, oHG", "KG einfach erkl√§rt", "Die oHG in der Praxis", "Chancen, Risiken", "Anwendung f√ºr kleine Unternehmen", "GmbH vs. UG", "Entscheidungshilfe f√ºr Gr√ºnder:innen", "Haftungsrisiken in der GmbH", "Co. KG", "und wie man sie begrenzt", "Die GmbH", "Co. KG im √úberblick", "wie sie funktioniert und wann sie sich lohnt", "Die AG im Mittelstand", "sinnvoll oder √ºberdimensioniert", "Steuerliche Transparenz vs. K√∂rperschaftsbesteuerung", "eine strategische Analyse"]},
            {"id": "gruendung_registrierung", "name": "üìù Gr√ºndung & Registrierung", "keywords": ["Was braucht man zur Gr√ºndung einer GmbH", "Handelsregisteranmeldung verst√§ndlich", "praxisnah erkl√§rt", "Achtung bei Handelsregister-Rechnungen", "wie erkenne ich betr√ºgerische Schreiben", "UG oder GmbH gr√ºnden", "was ist g√ºnstiger, schneller, sicherer", "H√§ufige Fehler bei Gesellschaftsgr√ºndungen", "und wie man sie vermeidet", "GmbH gegr√ºndet", "und jetzt? Die To-do-Liste nach der Eintragung", "Muster-Check: Gesellschaftsvertrag", "was muss wirklich rein", "Der Gr√ºndungsprozess bei der GmbH", "Co. KG", "Schritt f√ºr Schritt", "Gesellschafterwechsel vor oder nach Eintragung", "was ist zu beachten", "Vorratsgesellschaft kaufen oder selbst gr√ºnden", "Entscheidungshilfe f√ºr Gesch√§ftsf√ºhrer:innen"]},
            {"id": "einzelunternehmen", "name": "üë§ Einzelunternehmen", "keywords": ["Was ist ein Einzelunternehmen", "und f√ºr wen eignet es sich", "Wie gr√ºnde ich ein Einzelunternehmen", "Schritt f√ºr Schritt erkl√§rt", "Wie l√§uft die Gewerbeanmeldung f√ºr Einzelunternehmer:innen ab", "Haftung im Einzelunternehmen", "was bedeutet das konkret", "Freiberuf oder Gewerbe", "Was bin ich eigentlich, und warum ist das so wichtig", "Wie beende ich ein Einzelunternehmen", "und was muss ich beachten", "Was muss auf Rechnungen eines Einzelunternehmens stehen", "Vom Einzelunternehmen zur GmbH", "wie funktioniert der Wechsel", "Was muss ich als Einzelunternehmer:in auf Social Media beachten", "Die AG im Mittelstand", "sinnvoll oder √ºberdimensioniert"]},
            {"id": "gbr", "name": "üè¢ GbR - Gesellschaft b√ºrgerlichen Rechts", "keywords": ["Begriff und Wesen der GbR - Anwendungsbereiche", "Die Gr√ºndung einer GbR", "Voraussetzungen, Ablauf und Formerfordernisse", "Das Innenverh√§ltnis der GbR", "Gesch√§ftsf√ºhrung, Entscheidungsfindung und interne Haftung", "Das Au√üenverh√§ltnis der GbR", "Vertretung und externe Haftung", "Inhalte und Struktur eines GbR-Gesellschaftsvertrags", "Regelungsbereiche und Gestaltungsspielr√§ume", "Auftritt und Au√üenwahrnehmung der GbR", "Namensf√ºhrung, Impressum und Unternehmensauftritt", "GbR, oHG oder eGbR?", "Rechtsformwahl, Abgrenzung und Schwellenpr√ºfung", "Gesellschafterwechsel in der GbR", "Eintritt, Austritt und Nachfolgeregelung rechtskonform", "Wie beende ich eine GbR", "und worauf muss ich achten", "Haftung richtig begrenzen", "Vertragsgestaltung", "Risikovorsorge in der GbR"]},
            {"id": "ohg", "name": "üè™ OHG - offene Handelsgesellschaft", "keywords": ["Begriff und Rechtsnatur der oHG", "Abgrenzung zur GbR und Bedeutung als Handelsgesellschaft", "Gr√ºndung einer oHG", "Schritte, Anmeldung und Handelsregistereintrag", "Gesellschaftsvertrag der oHG", "gesetzliche Vorgaben und empfohlene Regelungen", "Innenverh√§ltnis der oHG", "Gesch√§ftsf√ºhrung, Stimmrechte und Beschlussfassung", "Beschlussfassung in der oHG", "Mehrheiten, Vetorechte und Sonderregelungen", "Au√üenverh√§ltnis der oHG", "Vertretungsmacht, Vertragsbindung und Publizit√§tspflichten", "Pflichten als Kaufleute", "Buchf√ºhrung, Wettbewerbsverbot, Offenlegung", "Haftung der Gesellschafter", "Umfang, Besonderheiten und Begrenzungsm√∂glichkeiten", "Gesellschafterwechsel in der oHG", "Eintritt, Austritt, Tod und Fortsetzung", "Beendigung und Liquidation der oHG", "Ablauf, Haftung, Nachschlusspflicht"]},
            {"id": "kg", "name": "ü§ù KG - Kommanditgesellschaft", "keywords": ["Begriff, Wesen und Rechtsnatur der KG", "Aufbau, Beteiligungs¬≠formen und Abgrenzung zur oHG", "Gr√ºndung einer KG", "Ablauf, Handelsregister, typische Fehler", "Gesellschaftsvertrag der KG", "Mindestanforderungen und Gestaltungs¬≠spielr√§ume", "Innenverh√§ltnis der KG", "Rechte, Pflichten und Kontrollmechanismen", "Au√üenverh√§ltnis und Vertretung", "wer handelt wie f√ºr die KG", "Haftung von Kommanditist:innen und Komplement√§r:innen", "Risiken", "Schutzmechanismen", "Beschlussfassung in der KG", "Stimmrechte, Sonderrechte, Vetoregeln", "Eintritt, Austritt und Nachfolge", "Gesellschafterwechsel in der KG", "Beendigung und Liquidation der KG", "Ablauf, Sonderfragen, Nachhaftung", "Die KG im Unternehmensverbund", "Holdingstrukturen, GmbH", "Co. KG, steuerliche Optimierung", "Die oHG im Konzern und Unternehmensverbund", "Kooperationsformen und Vertragskonstellationen"]},
            {"id": "gmbh_cokg", "name": "üè¢ GmbH & Co. KG", "keywords": ["Begriff, Struktur und Besonderheiten der GmbH", "Co. KG", "Trennung von Haftung", "F√ºhrung", "Gr√ºndung einer GmbH", "Co. KG", "Ablauf, Anforderungen und typische Fehlerquellen", "Gesellschaftsvertr√§ge in der GmbH", "Co. KG", "doppelte Vertragsstruktur rechtssicher gestalten", "Innenverh√§ltnis", "Zusammenspiel von GmbH, Kommanditist:innen und Gesch√§ftsf√ºhrung", "Haftungsstruktur in der GmbH", "Co. KG", "wer haftet wie wof√ºr", "Haftung von Kommanditist:innen und Komplement√§r:innen", "Risiken", "Schutzmechanismen", "Steuerliche Besonderheiten", "Mitunternehmerschaft, ¬ß 15 EStG, Verlustverrechnung", "Beteiligung von Familienmitgliedern", "Dritten", "Gesellschafterstrategie", "Verm√∂gensnachfolge", "Exit, Umwandlung", "Aufl√∂sung", "rechtssichere Beendigung der GmbH", "Co. KG", "Die GmbH", "Co. KG im Konzern", "Holdingstrukturen, Vertragsmodelle, Investoreneinstieg"]},
            {"id": "gmbh_beschraenkt", "name": "üíº GmbH - Gesellschaft mit beschr√§nkter...", "keywords": ["Begriff, Struktur und Rechtsnatur der GmbH", "Kapitalgesellschaft mit Personen¬≠element", "Gr√ºndung der GmbH", "Schritte, Kosten, Handelsregister", "Musterprotokoll", "Gesellschaftsvertrag der GmbH", "Pflichtbestandteile", "Gestaltungs¬≠spielr√§ume", "Disquotale Einzahlungen in die Kapitalr√ºcklage, F√∂rderung", "Finanzierung", "Gesellschaftsformstellung", "Gesch√§ftsf√ºhrung und Vertretung der GmbH", "Rechte, Pflichten", "Haftung", "Pflichten der Gesellschafter in der GmbH", "Kapital, Weisungen", "Treuepflicht", "Gesellschafterwechsel in der GmbH", "√úbertragung, Abtretung, Vinkulierung", "Einziehung", "Aufl√∂sung, Liquidation", "L√∂schung der GmbH", "Ablauf, Pflichten", "Nachhaftung", "Exit", "Umwandlung der GmbH", "Verschmelzung, Formwechsel", "Strukturwandel nach UmwG", "Die GmbH im Konzern", "Holdingstruktur, Organschaft", "Ergebnisabf√ºhrungsvertrag"]},
            {"id": "geschaeftsfuehrer", "name": "üëî GmbH Gesch√§ftsf√ºhrer", "keywords": ["Bestellung GF", "Voraussetzungen, Verfahren", "Praxishinweise", "Bestellung GF", "Besondere Bestellungsf√§lle", "Satzungsbestellung, Sonderrechte", "Bestellung GF", "Bestellung mehrerer Gesch√§ftsf√ºhrer:innen", "Vertretungsregelung, ¬ß 181 BGB Befreiung", "Vertretungsmacht GF", "Einzelvertretung, Gesamtvertretung", "Zeichnungsberechtigung", "Abberufung GF", "Rechtslage, Verfahren und Grenzen", "Abberufung GF - Trennung von Organstellung", "Anstellungsverh√§ltnis", "was endet wann", "Vertragsverh√§ltnis GF - Zustandekommen, Mindest¬≠inhalte", "Risiken ohne Vertrag", "Vertragsverh√§ltnis GF - Bei einer Konzern¬≠gesellschaft oder KG bei GmbH", "Co. KG", "Pflichten GF - Arbeitskraft", "Dienstort - Pr√§senzpflicht, Arbeitszeit", "Gesundheitspr√ºfung", "Pflichten GF - Nebent√§tigkeiten", "Pflichten GF - Verschwiegenheit und Vertraulichkeit w√§hrend und nach der T√§tigkeit"]},
            {"id": "ag", "name": "üìä AG - Aktiengesellschaft", "keywords": ["Begriff", "Wesen der Aktiengesellschaft", "Struktur, Abgrenzung", "Besonderheiten", "Gr√ºndung einer Aktiengesellschaft", "Voraussetzungen, Ablauf", "Besonderheiten", "Satzung", "Grundkapital der AG", "Anforderungen, Gestaltung", "Kapitalbindung", "Aktienarten", "√úbertragung", "Namensaktien, Inhaberaktien", "Vinkulierung in der AG", "Organe der AG", "Vorstand, Aufsichtsrat", "Hauptversammlung im √úberblick", "Bestellung", "Abberufung des Vorstands", "Verfahren, Voraussetzungen", "Mitbestimmung", "Rechte", "Pflichten des Vorstands", "Legalit√§tspflicht, Vertretung", "Haftung", "¬ß¬ß 93 AktG", "Aufgaben des Aufsichtsrats", "√úberwachung, Bestellung", "Berichtspflichten", "Hauptversammlung", "Ablauf, Beschlussfassung", "Rechte der Aktion√§re", "¬ß¬ß 118‚Äì147 AktG", "Kapitalma√ünahmen in der AG", "Kapitalerh√∂hung, -herabsetzung", "Bezugsrechte", "¬ß¬ß 182‚Äì240 AktG", "Investor Relations", "B√∂rseneinf√ºhrung", "Kommunikation, IPO", "Kapitalmarkt¬≠anforderungen", "Besonderheiten b√∂rsennotierter AGs", "Governance-Kodex", "Kapitalmarktrecht", "Beendigung", "Liquidation der AG", "Aufl√∂sung, Abwicklung", "L√∂schung", "¬ß¬ß 262‚Äì274 AktG"]},
            {"id": "transparenzregister", "name": "üìã Transparenzregister", "keywords": ["Eintragungspflicht pr√ºfen", "Wer muss ins Transparenz¬≠register", "Ermittlung wirtschaftlich Berechtigter", "Schritt f√ºr Schritt nach ¬ß 3 GwG", "Eintragungsverfahren", "Registermeldung bis zur Registermeldung", "¬ß 19 GwG", "Mehrstufige Beteiligungs¬≠ketten", "Wer gilt als wirtschaftlich Berechtigter", "Sonderf√§lle", "Stiftung, Trust, GbR", "Vereine im Transparenz¬≠register", "Registereintr√§ge aktualisieren", "Welche √Ñnderungen m√ºssen gemeldet werden", "Umsatzsteuerliche Korrekturen bei uneinbringlichen Forderungen", "¬ß17 UStG", "Ausl√§ndische Gesellschaft mit Immobilien¬≠eigentum in Deutschland", "Eintragungs¬≠pflicht", "Unstimmigkeits¬≠meldungen", "Bu√ügelder vermeiden", "Pflichten", "Praxistipps", "¬ß 23a, ¬ß 56 GwG", "Checkliste f√ºr Berater", "Wann besteht Handlungs¬≠bedarf im Transparenz¬≠register"]},
        ]
    }
}
    }

    // Map prompt to theme based on keywords
    getPromptTheme(prompt, role) {
        const roleThemes = this.themeMapping[role];
        if (!roleThemes) return null;

        for (const theme of roleThemes.themes) {
            for (const keyword of theme.keywords) {
                if (prompt.name.toLowerCase().includes(keyword.toLowerCase())) {
                    return theme.id;
                }
            }
        }
        
        // Fallback: return first theme
        return roleThemes.themes[0].id;
    }

    // Get prompts for a specific theme
    getPromptsForTheme(role, themeId) {
        return this.allPrompts.filter(p => {
            if (p.category !== role) return false;
            const promptTheme = this.getPromptTheme(p, role);
            return promptTheme === themeId;
        });
    }

    // Get theme statistics
    getThemeStats(role, themeId) {
        const prompts = this.getPromptsForTheme(role, themeId);
        return {
            total: prompts.length,
            fundamental: prompts.filter(p => p.tags?.includes('Fundamental')).length,
            erweitert: prompts.filter(p => p.tags?.includes('Erweitert')).length,
            premium: prompts.filter(p => p.tags?.includes('Premium')).length
        };
    }

    getRoleCount() {
        const roles = new Set(this.allPrompts.map(p => p.category));
        return roles.size;
    }

    init(context = null) {
        if (context) {
            this.addTaskFromCommandCenter(context);
        }
        this.renderMainView();
        console.log('‚úÖ Prompts Engine ready (3-Level)');
    }

    addTaskFromCommandCenter(context) {
        const task = {
            id: Date.now(),
            title: context.task,
            agent: this.getAgentName(context.agentId),
            agentId: context.agentId,
            matchScore: context.matchScore || 98,
            source: context.email ? 'email' : 'manual',
            email: context.email,
            attachments: context.attachments || [],
            timestamp: new Date().toISOString()
        };
        
        const exists = this.taskQueue.find(t => 
            t.title === task.title && t.agentId === task.agentId
        );
        
        if (!exists) {
            this.taskQueue.push(task);
            console.log('‚úÖ Task added to queue:', task);
        }
    }

    /* ========================================== */
    /* MAIN VIEW RENDERING */
    /* ========================================== */

    renderMainView() {
        const container = document.getElementById('prompts-content');
        if (!container) return;
        
        container.innerHTML = `
            <!-- Mode Switcher -->
            <div class="mode-switcher">
                <button 
                    class="mode-btn ${this.currentMode === 'templates' ? 'active' : ''}"
                    onclick="window.promptsEngine.switchMode('templates')"
                >
                    üìö Expert Templates
                </button>
                <button 
                    class="mode-btn ${this.currentMode === 'freeform' ? 'active' : ''}"
                    onclick="window.promptsEngine.switchMode('freeform')"
                >
                    üÜì Custom Builder
                </button>
            </div>
            
            ${this.currentMode === 'templates' ? this.renderTemplateMode() : this.renderFreeFormMode()}
        `;
        
        this.setupEventListeners();
    }

    switchMode(mode) {
        this.currentMode = mode;
        this.currentView = 'roles';
        this.currentRole = null;
        this.currentTheme = null;
        this.currentPrompt = null;
        this.renderMainView();
    }

    renderTemplateMode() {
        // Render based on current view
        if (this.currentView === 'roles') {
            return this.renderRolesView();
        } else if (this.currentView === 'themes') {
            return this.renderThemesView();
        } else if (this.currentView === 'prompts') {
            return this.renderPromptsView();
        }
    }

    /* ========================================== */
    /* LEVEL 1: ROLES VIEW */
    /* ========================================== */

    renderRolesView() {
        const roles = this.getRoles();
        
        return `
            <div class="prompts-template-section">
                <h2 class="section-title">üíº W√§hle deine Rolle</h2>
                <p class="section-subtitle">${this.allPrompts.length} Prompts in ${roles.length} Rollen verf√ºgbar</p>
                
                <div class="roles-grid">
                    ${roles.map(role => this.renderRoleCard(role)).join('')}
                </div>
            </div>
        `;
    }

    renderRoleCard(role) {
        const roleIcon = this.getRoleIcon(role.name);
        return `
            <div class="role-card" onclick="window.promptsEngine.selectRole('${role.name}')">
                <div class="role-icon">${roleIcon}</div>
                <div class="role-info">
                    <h3 class="role-name">${role.name}</h3>
                    <p class="role-count">${role.count} Prompts verf√ºgbar</p>
                </div>
                <div class="role-arrow">‚Üí</div>
            </div>
        `;
    }

    /* ========================================== */
    /* LEVEL 2: THEMES VIEW */
    /* ========================================== */

    renderThemesView() {
        const roleData = this.themeMapping[this.currentRole];
        if (!roleData) return '';

        const roleIcon = this.getRoleIcon(this.currentRole);
        const totalPrompts = this.allPrompts.filter(p => p.category === this.currentRole).length;

        return `
            <div class="prompts-template-section">
                <!-- Breadcrumb Navigation -->
                <div class="breadcrumb-nav">
                    <button onclick="window.promptsEngine.goBackToRoles()" class="breadcrumb-back">
                        ‚Üê Zur√ºck zu Rollen
                    </button>
                </div>

                <h2 class="section-title">${roleIcon} ${this.currentRole}</h2>
                <p class="section-subtitle">${totalPrompts} Prompts in ${roleData.themes.length} Hauptthemen</p>
                
                <div class="themes-grid">
                    ${roleData.themes.map(theme => this.renderThemeCard(theme)).join('')}
                </div>
            </div>
        `;
    }

    renderThemeCard(theme) {
        const stats = this.getThemeStats(this.currentRole, theme.id);
        
        return `
            <div class="theme-card" onclick="window.promptsEngine.selectTheme('${theme.id}')">
                <div class="theme-header">
                    <h3 class="theme-name">${theme.name}</h3>
                    <div class="theme-arrow">‚Üí</div>
                </div>
                <div class="theme-stats">
                    <span class="theme-count">${stats.total} Prompts</span>
                    ${stats.fundamental > 0 ? `<span class="badge badge-fundamental">${stats.fundamental} Fundamental</span>` : ''}
                    ${stats.erweitert > 0 ? `<span class="badge badge-erweitert">${stats.erweitert} Erweitert</span>` : ''}
                    ${stats.premium > 0 ? `<span class="badge badge-premium">${stats.premium} Premium</span>` : ''}
                </div>
            </div>
        `;
    }

    /* ========================================== */
    /* LEVEL 3: PROMPTS VIEW */
    /* ========================================== */

    renderPromptsView() {
        const prompts = this.getPromptsForTheme(this.currentRole, this.currentTheme);
        const roleData = this.themeMapping[this.currentRole];
        const theme = roleData.themes.find(t => t.id === this.currentTheme);
        
        if (!theme) return '';

        return `
            <div class="prompts-template-section">
                <!-- Breadcrumb Navigation -->
                <div class="breadcrumb-nav">
                    <button onclick="window.promptsEngine.goBackToThemes()" class="breadcrumb-back">
                        ‚Üê Zur√ºck zu ${this.currentRole}
                    </button>
                </div>

                <h2 class="section-title">${theme.name}</h2>
                <p class="section-subtitle">${prompts.length} Prompts verf√ºgbar</p>
                
                <!-- Prompt List -->
                <div class="prompt-list-simple">
                    ${prompts.map(prompt => this.renderPromptListItem(prompt)).join('')}
                </div>
            </div>
        `;
    }

    renderPromptListItem(prompt) {
        const impactClass = prompt.tags?.includes('Premium') ? 'premium' : 
                          prompt.tags?.includes('Erweitert') ? 'erweitert' : 'fundamental';
        
        return `
            <div class="prompt-list-item" onclick="window.promptsEngine.selectPrompt('${prompt.id}')">
                <div class="prompt-icon">${prompt.icon || 'üìÑ'}</div>
                <div class="prompt-details">
                    <h4 class="prompt-name">${prompt.name}</h4>
                    <div class="prompt-meta">
                        <span class="badge badge-${impactClass}">${prompt.tags?.[0] || 'Standard'}</span>
                        <span class="prompt-duration">‚è±Ô∏è ${prompt.duration || 30} Min</span>
                    </div>
                </div>
                <div class="prompt-arrow">‚Üí</div>
            </div>
        `;
    }

    /* ========================================== */
    /* NAVIGATION METHODS */
    /* ========================================== */

    selectRole(roleName) {
        this.currentRole = roleName;
        this.currentView = 'themes';
        this.currentTheme = null;
        this.currentPrompt = null;
        this.renderMainView();
    }

    selectTheme(themeId) {
        this.currentTheme = themeId;
        this.currentView = 'prompts';
        this.currentPrompt = null;
        this.renderMainView();
    }

    selectPrompt(promptId) {
        const prompt = this.allPrompts.find(p => p.id === promptId);
        if (!prompt) return;
        
        this.currentPrompt = prompt;
        this.renderPromptDetail(prompt);
    }

    goBackToRoles() {
        this.currentView = 'roles';
        this.currentRole = null;
        this.currentTheme = null;
        this.currentPrompt = null;
        this.renderMainView();
    }

    goBackToThemes() {
        this.currentView = 'themes';
        this.currentTheme = null;
        this.currentPrompt = null;
        this.renderMainView();
    }

    goBackToPrompts() {
        this.currentPrompt = null;
        this.renderMainView();
    }

    /* ========================================== */
    /* PROMPT DETAIL VIEW */
    /* ========================================== */

    renderPromptDetail(prompt) {
    const container = document.getElementById('prompts-content');
    if (!container) return;

    let fullPromptText = prompt.fullPromptText;
    if (!fullPromptText && prompt.goal && prompt.questions) {
        fullPromptText = `${prompt.goal}\n\n`;
        prompt.questions.forEach((q, idx) => {
            fullPromptText += `${idx + 1}. ${q.question}\n`;
            if (q.example) fullPromptText += `   Beispiel: ${q.example}\n`;
            fullPromptText += '\n';
        });
    }
    
    if (!fullPromptText) {
        fullPromptText = prompt.goal || prompt.name || 'Kein Prompt-Text verf√ºgbar';
    }

    const extractedQuestions = this.extractQuestionsFromPrompt(prompt);
    const summary = this.extractSummary(prompt);

    container.innerHTML = `
        <div class="prompt-detail-view">
            <div class="breadcrumb-nav">
                <button onclick="window.promptsEngine.goBackToPrompts()" class="breadcrumb-back">
                    ‚Üê Zur√ºck
                </button>
            </div>

            <div class="prompt-detail-header">
                <div class="prompt-icon-large">${prompt.icon || 'üìÑ'}</div>
                <div>
                    <h2 class="prompt-detail-title">${prompt.name}</h2>
                    <p class="prompt-detail-meta">${prompt.category} ‚Ä¢ ‚è±Ô∏è ${prompt.duration || 30} Min</p>
                </div>
            </div>

            <!-- üÜï BUSINESS PARTNER SUMMARY -->
            <div class="prompt-summary-sticky">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">üí° Kurz erkl√§rt</div>
                <div style="font-size: 14px; margin-bottom: 12px; line-height: 1.6;">${summary}</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <span style="padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 12px;">‚úÖ Revisionssicher</span>
                    <span style="padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 12px;">‚úÖ Professionell</span>
                    <span style="padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 12px;">‚úÖ Business Partner Ready</span>
                </div>
            </div>

            <div class="prompt-split-container">
                
                <!-- LEFT: Input Panel mit Business Context -->
                <div class="prompt-input-panel">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1a202c;">üîç Ihre Eingaben</h3>
                    
                    ${extractedQuestions.length > 0 ? 
                        extractedQuestions.map((q, idx) => `
                            <div style="margin-bottom: 28px;">
                                
                                <!-- üÜï CONTEXT CARD: Warum fragen wir das? -->
                                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 14px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #0ea5e9; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <div style="font-size: 20px; line-height: 1;">üí°</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 13px; font-weight: 600; color: #0c4a6e; margin-bottom: 6px;">
                                                Warum fragen wir das?
                                            </div>
                                            <div style="font-size: 12px; color: #075985; line-height: 1.5;">
                                                ${this.getQuestionContext(q.question, idx, prompt.category)}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Frage Label -->
                                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #2d3748;">
                                    ${q.number}. ${this.escapeHtml(q.question)}
                                </label>

                                <!-- Input Field mit Smart Validation -->
                                <input 
                                    type="text" 
                                    style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease;"
                                    id="input-${prompt.id}-${idx}"
                                    placeholder="${this.getSmartPlaceholder(q.question, q.example)}"
                                    oninput="window.promptsEngine.updateLivePreviewWithValidation('${prompt.id}', ${idx}, this.value, '${this.escapeHtml(q.question).replace(/'/g, "\\'")}')"
                                    onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                    onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"
                                />

                                <!-- üÜï QUALITY FEEDBACK -->
                                <div id="feedback-${prompt.id}-${idx}" style="margin-top: 8px; font-size: 12px; min-height: 18px;">
                                    ${q.example ? `<span style="color: #64748b; font-style: italic;">üí° Beispiel: ${this.escapeHtml(q.example)}</span>` : ''}
                                </div>
                            </div>
                        `).join('') 
                        : '<p style="color: #64748b; font-size: 14px;">Keine Eingaben erforderlich.</p>'
                    }

                    <!-- Zus√§tzliche Hinweise -->
                    ${extractedQuestions.length > 0 ? `
                        <div style="margin-top: 28px; padding-top: 24px; border-top: 2px solid #f1f5f9;">
                            
                            <!-- Context Card f√ºr zus√§tzliche Hinweise -->
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 14px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #f59e0b;">
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <div style="font-size: 20px; line-height: 1;">üíº</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: 600; color: #78350f; margin-bottom: 6px;">
                                            Business Partner Tipp
                                        </div>
                                        <div style="font-size: 12px; color: #92400e; line-height: 1.5;">
                                            Nutzen Sie dieses Feld f√ºr spezifische Kontextinformationen, die f√ºr Ihre Situation relevant sind. 
                                            Z.B.: Branchenbesonderheiten, regulatorische Anforderungen, oder strategische Priorit√§ten.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #2d3748;">
                                ‚ûï Zus√§tzliche Hinweise (optional)
                            </label>
                            <textarea
                                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; min-height: 100px; font-family: inherit; transition: all 0.3s ease;"
                                id="additional-${prompt.id}"
                                placeholder="z.B.: Bitte beachte unsere spezielle Branchensituation im Automotive-Sektor mit volatilen Rohstoffpreisen und EU-Regulierungen..."
                                oninput="window.promptsEngine.updateAdditionalHints('${prompt.id}', this.value)"
                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'"
                            ></textarea>
                            <div style="font-size: 12px; color: #64748b; margin-top: 6px; font-style: italic;">
                                üí° Je spezifischer Ihre Hinweise, desto besser der AI-Output!
                            </div>
                        </div>
                    ` : ''}

                    <!-- üÜï QUALITY SCORE -->
                    <div id="quality-score-${prompt.id}" style="margin-top: 24px; padding: 16px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #94a3b8;">
                        <div style="font-size: 14px; font-weight: 600; color: #475569; margin-bottom: 8px;">
                            üìä Prompt Quality Score
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                <div id="quality-bar-${prompt.id}" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f59e0b 0%, #10b981 100%); transition: width 0.3s ease;"></div>
                            </div>
                            <div id="quality-percent-${prompt.id}" style="font-size: 18px; font-weight: 700; color: #475569; min-width: 50px;">0%</div>
                        </div>
                        <div id="quality-tips-${prompt.id}" style="font-size: 12px; color: #64748b;">
                            F√ºllen Sie die Felder aus, um die Prompt-Qualit√§t zu erh√∂hen
                        </div>
                    </div>

                    <!-- Progress -->
                    <div class="progress-indicator" id="progress-${prompt.id}" style="margin-top: 20px;">
                        ‚è∫Ô∏è Bitte ausf√ºllen (0/${extractedQuestions.length})
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="window.promptsEngine.executePrompt('${prompt.id}')">
                            ‚ñ∂Ô∏è Prompt ausf√ºhren
                        </button>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                        <button class="btn btn-secondary" onclick="window.promptsEngine.copyPromptCode('${prompt.id}')">
                            üìã Kopieren
                        </button>
                        <button class="btn btn-secondary" onclick="window.promptsEngine.addToQueue('${prompt.id}')">
                            ‚ûï Task Queue
                        </button>
                    </div>
                </div>

                <!-- RIGHT: Live Preview Panel -->
                <div class="prompt-preview-panel">
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #f1f5f9; color: #1a202c;">
                        üìñ Prompt Live-Preview
                    </h3>
                    
                    <div style="font-size: 14px; line-height: 1.8; color: #334155; white-space: pre-wrap; font-family: inherit;" id="preview-${prompt.id}">
                        ${this.renderPreviewWithPlaceholders(prompt, fullPromptText, extractedQuestions)}
                    </div>

                    <!-- üÜï TRANSPARENCY BOX -->
                    <div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 8px;">
                        <div style="font-size: 14px; font-weight: 600; color: #1e40af; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                            <span>üîç</span> 100% Transparenz (Explainable AI)
                        </div>
                        <div style="font-size: 13px; color: #1e3a8a; line-height: 1.7;">
                            ‚úÖ Sie sehen <strong>exakt</strong>, was an die AI gesendet wird<br>
                            ‚úÖ Ihre Eingaben werden <strong>live</strong> im Prompt angezeigt<br>
                            ‚úÖ Keine versteckten Anweisungen - <strong>100% Glass Box</strong><br>
                            ‚úÖ Context Cards helfen Ihnen, <strong>bessere Eingaben</strong> zu machen
                        </div>
                    </div>
                </div>

            </div>
        </div>
    `;

    this.initializeQualityScore(prompt.id, extractedQuestions.length);
    this.updateProgress(prompt.id, extractedQuestions.length);
}

/* ========================================== */
/* üÜï NEUE BUSINESS PARTNER METHODEN */
/* ========================================== */

/**
 * 1. Context f√ºr jede Frage generieren
 */
getQuestionContext(question, index, category) {
    const questionLower = question.toLowerCase();
    
    // ========== SPEZIFISCHE PATTERN (Bilanzbuchhalter) ==========
    if (category === 'Bilanzbuchhalter') {
        
        // Bilanzposten / Sachverhalt
        if (questionLower.includes('bilanzposten') || questionLower.includes('sachverhalt')) {
            return 'Pr√§zise Angaben zum Bilanzposten sind essentiell f√ºr eine korrekte bilanzielle Behandlung. Je konkreter Ihre Beschreibung, desto besser kann die rechtssichere Einordnung und Dokumentation erfolgen.';
        }
        
        // Entwicklung / GuV / Bilanz
        if (questionLower.includes('entwicklung') || questionLower.includes('guv') || questionLower.includes('bilanz')) {
            return 'Die Entwicklungen in GuV und Bilanz sind das Herzst√ºck Ihrer Finanzberichterstattung. Investoren, Banken und Wirtschaftspr√ºfer analysieren diese Kennzahlen, um Ihre Unternehmensentwicklung zu bewerten. Geben Sie konkrete Zahlen und Prozente an (z.B. "Umsatz +15%").';
        }
        
        // Standards / HGB / IFRS / US-GAAP
        if (questionLower.includes('standard') || questionLower.includes('hgb') || questionLower.includes('ifrs') || questionLower.includes('gaap') || questionLower.includes('rechnungslegung')) {
            return 'Die Wahl des Rechnungslegungsstandards bestimmt die Bilanzierungs- und Bewertungsmethoden. IFRS und HGB unterscheiden sich erheblich - eine klare Angabe ist f√ºr die rechtssichere Bearbeitung zwingend erforderlich.';
        }
        
        // Einfl√ºsse / Finanzierung / Investition
        if (questionLower.includes('einfl√ºsse') || questionLower.includes('einfluss') || questionLower.includes('finanzierung') || questionLower.includes('investition')) {
            return 'Au√üergew√∂hnliche Einfl√ºsse aus Finanzierung oder Investitionen m√ºssen separat ausgewiesen werden (¬ß 277 Abs. 4 HGB). Dies erh√∂ht die Vergleichbarkeit und Transparenz. Nennen Sie konkrete Betr√§ge und Ursachen.';
        }
        
        // Kennzahlen / EBIT / Cashflow / KPI
        if (questionLower.includes('kennzahlen') || questionLower.includes('ebit') || questionLower.includes('cashflow') || questionLower.includes('quote') || questionLower.includes('kpi')) {
            return 'Diese Kennzahlen sind entscheidend f√ºr die Beurteilung Ihrer Ertragskraft und Liquidit√§t. Banken nutzen sie f√ºr Kreditentscheidungen, Investoren f√ºr Bewertungen. W√§hlen Sie die f√ºr Ihre Branche relevanten KPIs.';
        }
        
        // Vorjahreswerte / Benchmark / Vergleich
        if (questionLower.includes('vorjahres') || questionLower.includes('benchmark') || questionLower.includes('vergleich')) {
            return 'Der Vergleich mit Vorjahren oder externen Benchmarks zeigt Trends und positioniert Ihr Unternehmen im Wettbewerb. Dies ist besonders wichtig f√ºr Stakeholder-Kommunikation und strategische Entscheidungen.';
        }
        
        // Wirtschaftsgut / Verm√∂gensgegenstand
        if (questionLower.includes('wirtschaftsgut') || questionLower.includes('verm√∂gen')) {
            return 'Die korrekte Identifikation und Klassifizierung von Wirtschaftsg√ºtern ist Basis f√ºr Abschreibung, Bewertung und steuerliche Behandlung. Beschreiben Sie Art, Zweck und geplante Nutzungsdauer.';
        }
        
        // Nutzung / Nutzungsdauer
        if (questionLower.includes('nutzung') || questionLower.includes('dauer')) {
            return 'Die voraussichtliche Nutzungsdauer bestimmt Abschreibungsmethode und -dauer. Sie ist relevant f√ºr Anlage- vs. Umlaufverm√∂gen und beeinflusst GuV und Bilanz √ºber mehrere Jahre.';
        }
        
        // Zeitraum / Zeitpunkt
        if (questionLower.includes('zeitraum') || questionLower.includes('zeitpunkt') || questionLower.includes('wann') || questionLower.includes('bis wann')) {
            return 'Zeitliche Angaben sind entscheidend f√ºr Periodisierung, Stichtagsbewertung und Vollst√§ndigkeit. Sie bestimmen in welchem Gesch√§ftsjahr Aufwendungen und Ertr√§ge zu erfassen sind.';
        }
        
        // Aufwendungen / Kosten / Ausgaben
        if (questionLower.includes('aufwend') || questionLower.includes('kosten') || questionLower.includes('ausgab')) {
            return 'Detaillierte Aufwendungsanalyse erm√∂glicht korrekte Zuordnung, Aktivierungsf√§higkeit und steuerliche Behandlung. Unterscheiden Sie zwischen Anschaffungs-, Herstellungs- und laufenden Kosten.';
        }
        
        // Abzinsung / Bewertung / Sch√§tzung
        if (questionLower.includes('abzins') || questionLower.includes('bewert') || questionLower.includes('sch√§tz') || questionLower.includes('zinssatz')) {
            return 'Bewertungsparameter wie Abzinsungss√§tze beeinflussen direkt den Bilanzausweis und haben GuV-Wirkung. Sie m√ºssen sachgerecht begr√ºndet und dokumentiert werden (GoB, IAS 1).';
        }
        
        // Steuerliche Aspekte
        if (questionLower.includes('steuer') || questionLower.includes('finanzamt') || questionLower.includes('betriebspr√ºfung')) {
            return 'Steuerliche Aspekte k√∂nnen von der Handelsbilanz abweichen. Eine klare Dokumentation hilft bei Betriebspr√ºfungen und sichert steuerliche Anerkennung von Sachverhalten ab.';
        }
    }
    
    // ========== CONTROLLER ==========
    if (category === 'Controller') {
        
        // Kosten / Aufwand
        if (questionLower.includes('kosten') || questionLower.includes('aufwand')) {
            return 'Eine detaillierte Kostenanalyse ist die Basis f√ºr fundierte Managemententscheidungen. Unterscheiden Sie zwischen fixen und variablen Kosten, um Hebel f√ºr Effizienzsteigerungen zu identifizieren.';
        }
        
        // Budget / Planung / Forecast
        if (questionLower.includes('budget') || questionLower.includes('planung') || questionLower.includes('forecast') || questionLower.includes('plan')) {
            return 'Pr√§zise Budgetierung und Forecasting sind Ihre Kernaufgaben als Business Partner. Managemententscheidungen basieren auf Ihren Zahlen - je besser die Datenqualit√§t, desto besser die Entscheidungen.';
        }
        
        // Abweichung / Analyse / Variance
        if (questionLower.includes('abweichung') || questionLower.includes('analyse') || questionLower.includes('variance')) {
            return 'Abweichungsanalysen decken Potenziale und Risiken auf. Als Business Partner erkl√§ren Sie nicht nur "was" abweicht, sondern vor allem "warum" und "was zu tun ist".';
        }
        
        // KPI / Kennzahlen / Metrics
        if (questionLower.includes('kpi') || questionLower.includes('kennzahl') || questionLower.includes('metric')) {
            return 'KPIs sind Ihr Steuerungsinstrument. W√§hlen Sie Kennzahlen, die wirklich gesch√§ftsrelevant sind und zum Handeln f√ºhren - nicht nur "nice to know".';
        }
    }
    
    // ========== TREASURY ==========
    if (category === 'Treasury') {
        
        // Liquidit√§t / Cash
        if (questionLower.includes('liquidit√§t') || questionLower.includes('cash') || questionLower.includes('zahlungsf√§hig')) {
            return 'Liquidit√§tssicherung ist Ihre Kernaufgabe. Banken und Management verlassen sich darauf, dass Sie Cashflow-Risiken fr√ºhzeitig erkennen und absichern.';
        }
        
        // Finanzierung / Kredit / Darlehen
        if (questionLower.includes('finanzierung') || questionLower.includes('kredit') || questionLower.includes('darlehen')) {
            return 'Die richtige Finanzierungsstruktur optimiert Ihre Kapitalkosten und sichert finanzielle Flexibilit√§t. Ber√ºcksichtigen Sie sowohl Kosten als auch strategische Aspekte.';
        }
        
        // Risiko / Hedging / W√§hrung
        if (questionLower.includes('risiko') || questionLower.includes('hedge') || questionLower.includes('w√§hrung') || questionLower.includes('zins')) {
            return 'Aktives Risikomanagement sch√ºtzt vor unerwarteten Verlusten. Dokumentieren Sie Absicherungsstrategien transparent f√ºr Wirtschaftspr√ºfer und Management.';
        }
    }
    
    // ========== CFO ==========
    if (category === 'CFO') {
        
        // Strategie / Transformation
        if (questionLower.includes('strategie') || questionLower.includes('transformation') || questionLower.includes('vision')) {
            return 'Als CFO gestalten Sie die finanzielle Zukunft des Unternehmens. Ihre Antworten sollten strategische √úberlegungen und langfristige Auswirkungen ber√ºcksichtigen.';
        }
        
        // Kapital / Investition / Allocation
        if (questionLower.includes('kapital') || questionLower.includes('investition') || questionLower.includes('allocation')) {
            return 'Capital Allocation ist eine Ihrer wichtigsten strategischen Entscheidungen. Sie bestimmt, wie Ihr Unternehmen Wert schafft und w√§chst.';
        }
        
        // M&A / Akquisition
        if (questionLower.includes('m&a') || questionLower.includes('akquisition') || questionLower.includes('√ºbernahme')) {
            return 'M&A-Entscheidungen sind strategische Weichenstellungen. Eine gr√ºndliche finanzielle und strategische Bewertung ist entscheidend f√ºr den Transaktionserfolg.';
        }
    }
    
    // ========== M&A ==========
    if (category === 'M&A') {
        
        // Due Diligence
        if (questionLower.includes('due diligence') || questionLower.includes('pr√ºfung') || questionLower.includes('dd')) {
            return 'Eine gr√ºndliche Due Diligence sch√ºtzt vor b√∂sen √úberraschungen und liefert die Basis f√ºr Kaufpreis und Vertragsgestaltung. Je detaillierter, desto besser.';
        }
        
        // Bewertung / Valuation / Preis
        if (questionLower.includes('bewertung') || questionLower.includes('valuation') || questionLower.includes('preis') || questionLower.includes('wert')) {
            return 'Die Unternehmensbewertung ist oft Verhandlungsbasis und bestimmt den Deal-Erfolg. Nutzen Sie mehrere Methoden und Szenarien f√ºr Robustheit.';
        }
        
        // Synergien / Integration
        if (questionLower.includes('synergie') || questionLower.includes('integration') || questionLower.includes('pmi')) {
            return 'Synergien sind der Werttreiber vieler Deals. Quantifizieren Sie diese realistisch und planen Sie die Integration sorgf√§ltig - 70% der Deals scheitern in der PMI.';
        }
    }
    
    // ========== GENERISCHE PATTERN (Fallback nach Keyword) ==========
    
    // Projekt / Initiative
    if (questionLower.includes('projekt') || questionLower.includes('initiative')) {
        return 'Klare Projektbeschreibungen erm√∂glichen bessere Einsch√§tzung von Ressourcenbedarf, Timeline und Risiken. Beschreiben Sie Ziel, Scope und erwartete Ergebnisse.';
    }
    
    // Betrag / Summe / H√∂he / Volumen
    if (questionLower.includes('betrag') || questionLower.includes('summe') || questionLower.includes('h√∂he') || questionLower.includes('volumen') || questionLower.includes('wie hoch') || questionLower.includes('wie viel')) {
        return 'Konkrete Betr√§ge sind essentiell f√ºr finanzielle Bewertung und Entscheidungsfindung. Geben Sie Gr√∂√üenordnungen an (z.B. "ca. 250.000 ‚Ç¨") f√ºr bessere Einordnung.';
    }
    
    // Grund / Ursache / Warum
    if (questionLower.includes('grund') || questionLower.includes('ursache') || questionLower.includes('warum') || questionLower.includes('weshalb')) {
        return 'Die Ursachenanalyse ist entscheidend f√ºr die Beurteilung von Einmaligkeit vs. Dauerhaftigkeit. Dies beeinflusst Prognosen, Planung und strategische Ma√ünahmen.';
    }
    
    // Wie lange / Dauer / Zeitraum
    if (questionLower.includes('wie lange') || questionLower.includes('dauer') || questionLower.includes('zeitraum') || questionLower.includes('frist')) {
        return 'Zeitliche Dimensionen sind wichtig f√ºr Planung, Periodisierung und Ressourcenallokation. Geben Sie realistische Zeitrahmen an.';
    }
    
    // Ja/Nein Fragen
    if (questionLower.includes('gibt es') || questionLower.includes('liegt vor') || questionLower.includes('existiert')) {
        return 'Diese Information hilft bei der Vollst√§ndigkeitspr√ºfung und Risikoeinsch√§tzung. Geben Sie auch bei "Nein" eine kurze Begr√ºndung an.';
    }
    
    // ========== ULTIMATE FALLBACK ==========
    // Wenn GAR NICHTS matched, dann basierend auf Position
    
    if (index === 0) {
        return 'Diese erste Frage hilft uns, den Kontext und Scope Ihrer Anfrage zu verstehen. Je pr√§ziser Ihre Antwort, desto passgenauer wird der AI-Output auf Ihre Situation zugeschnitten.';
    }
    
    if (index === 1) {
        return 'Diese Angabe erg√§nzt den Kontext und erm√∂glicht eine differenziertere Bearbeitung. F√ºgen Sie Details hinzu, die f√ºr Ihre spezifische Situation relevant sind.';
    }
    
    // Generischer Fallback f√ºr alle anderen
    return `Diese Information ist wichtig f√ºr die Vollst√§ndigkeit und Qualit√§t der Analyse. Je mehr relevante Details Sie angeben, desto pr√§ziser und wertvoller wird das Ergebnis f√ºr Ihre Business-Entscheidung. 
    
    üí° Tipp: Nutzen Sie konkrete Zahlen, Beispiele und Kontext aus Ihrer spezifischen Situation.`;
}

/* ========================================== */
/* ENDE DER VERBESSERTEN METHODE */
/* ========================================== */

/**
 * 2. Smarte Placeholders generieren
 */
getSmartPlaceholder(question, example) {
    const questionLower = question.toLowerCase();
    
    // Wenn Beispiel vorhanden, verwende es
    if (example && example.length > 5) {
        return this.escapeHtml(example);
    }
    
    // Intelligente Placeholders basierend auf Frage
    if (questionLower.includes('entwicklung') && (questionLower.includes('guv') || questionLower.includes('bilanz'))) {
        return 'z.B.: Umsatz +15% auf 5,6 Mio ‚Ç¨, EBIT -3% auf 820 T‚Ç¨ durch Personalkostenanstieg';
    }
    if (questionLower.includes('einfl√ºsse') && questionLower.includes('finanzierung')) {
        return 'z.B.: Zinsertr√§ge +250 T‚Ç¨ aus Festgeldanlage, au√üerplanm√§√üige Abschreibung -180 T‚Ç¨';
    }
    if (questionLower.includes('kennzahlen')) {
        return 'z.B.: EBIT-Marge 14,6%, Cashflow 1,2 Mio ‚Ç¨, EK-Quote 45%';
    }
    if (questionLower.includes('vorjahreswerte') || questionLower.includes('benchmark')) {
        return 'z.B.: Ja, Branchendurchschnitt EBIT-Marge 12%, wir liegen bei 14,6%';
    }
    if (questionLower.includes('kosten')) {
        return 'z.B.: Personalkosten 2,1 Mio ‚Ç¨ (+8%), Materialkosten 1,8 Mio ‚Ç¨ (+12%)';
    }
    if (questionLower.includes('liquidit√§t')) {
        return 'z.B.: Aktuell 850 T‚Ç¨, mindestens 500 T‚Ç¨ erforderlich, 13-Wochen-Forecast positiv';
    }
    
    // Default
    return 'Ihre Antwort - je detaillierter, desto besser';
}

/**
 * 3. Live Preview mit Validation
 */
updateLivePreviewWithValidation(promptId, fieldIndex, value, questionText) {
    // Update Placeholder (wie vorher)
    const placeholder = document.getElementById(`placeholder-${promptId}-${fieldIndex}`);
    
    if (placeholder) {
        if (value && value.trim() !== '') {
            placeholder.className = 'user-input-highlight';
            placeholder.textContent = value;
        } else {
            placeholder.className = 'placeholder-text';
            placeholder.textContent = '[Eingabe erforderlich]';
        }
    }

    // Update Answers
    if (!this.userAnswers[promptId]) {
        this.userAnswers[promptId] = {};
    }
    this.userAnswers[promptId][fieldIndex] = value;

    // üÜï VALIDATION & FEEDBACK
    const feedback = document.getElementById(`feedback-${promptId}-${fieldIndex}`);
    if (feedback && value && value.trim() !== '') {
        const validationResult = this.validateInput(value, questionText);
        
        if (validationResult.score >= 80) {
            feedback.innerHTML = `<span style="color: #10b981;">‚úÖ ${validationResult.message}</span>`;
        } else if (validationResult.score >= 50) {
            feedback.innerHTML = `<span style="color: #f59e0b;">üí° ${validationResult.message}</span>`;
        } else {
            feedback.innerHTML = `<span style="color: #ef4444;">‚ö†Ô∏è ${validationResult.message}</span>`;
        }
    }

    // Update Progress & Quality Score
    const prompt = this.allPrompts.find(p => p.id === promptId);
    if (prompt) {
        const extractedQuestions = this.extractQuestionsFromPrompt(prompt);
        this.updateProgress(promptId, extractedQuestions.length);
        this.updateQualityScore(promptId, extractedQuestions.length);
    }
}

/**
 * 4. Input Validation
 */
validateInput(value, questionText) {
    const questionLower = questionText.toLowerCase();
    let score = 50; // Basis-Score
    let message = 'Eingabe erhalten';
    
    // L√§ngen-Check
    if (value.length < 10) {
        return { score: 20, message: 'Zu kurz! Bitte detaillierter (mindestens 10 Zeichen).' };
    }
    if (value.length >= 20) score += 10;
    if (value.length >= 50) score += 10;
    
    // Zahlen/Prozente f√ºr quantitative Fragen
    if (questionLower.includes('entwicklung') || questionLower.includes('kennzahlen') || questionLower.includes('kosten')) {
        if (value.match(/\d/) && (value.includes('%') || value.includes('‚Ç¨') || value.includes('Mio') || value.includes('T‚Ç¨'))) {
            score += 20;
            message = 'Sehr gut! Konkrete Zahlen angegeben.';
        } else {
            score -= 10;
            message = 'Tipp: F√ºgen Sie Zahlen/Prozente hinzu (z.B. "+15%" oder "2,5 Mio ‚Ç¨")';
        }
    }
    
    // Struktur-Check (Kommas, Stichpunkte)
    if (value.includes(',') || value.includes(';') || value.includes('‚Ä¢')) {
        score += 10;
    }
    
    // Final Message
    if (score >= 80) {
        message = 'Exzellent! Sehr detaillierte und strukturierte Eingabe.';
    } else if (score >= 60) {
        message = 'Gut! Eingabe ist ausreichend detailliert.';
    }
    
    return { score: Math.min(score, 100), message };
}

/**
 * 5. Quality Score initialisieren
 */
initializeQualityScore(promptId, totalFields) {
    if (!totalFields) return;
    
    // Initial auf 0
    this.updateQualityScore(promptId, totalFields);
}

/**
 * 6. Quality Score aktualisieren
 */
updateQualityScore(promptId, totalFields) {
    if (!totalFields) return;
    
    let totalScore = 0;
    let filledCount = 0;
    
    // Berechne Score f√ºr jedes Feld
    for (let i = 0; i < totalFields; i++) {
        const input = document.getElementById(`input-${promptId}-${i}`);
        if (input && input.value.trim() !== '') {
            filledCount++;
            
            // Einfacher Score: L√§nge + Zahlen
            let fieldScore = Math.min(input.value.length, 100);
            if (input.value.match(/\d/) && (input.value.includes('%') || input.value.includes('‚Ç¨'))) {
                fieldScore += 20;
            }
            totalScore += Math.min(fieldScore, 100);
        }
    }
    
    // Zus√§tzliche Hinweise bonus
    const additional = document.getElementById(`additional-${promptId}`);
    if (additional && additional.value.trim() !== '') {
        totalScore += Math.min(additional.value.length / 2, 50);
    }
    
    // Durchschnitt
    const maxScore = totalFields * 100 + 50; // +50 f√ºr additional
    const percentScore = Math.round((totalScore / maxScore) * 100);
    
    // Update UI
    const bar = document.getElementById(`quality-bar-${promptId}`);
    const percent = document.getElementById(`quality-percent-${promptId}`);
    const tips = document.getElementById(`quality-tips-${promptId}`);
    
    if (bar) bar.style.width = percentScore + '%';
    if (percent) percent.textContent = percentScore + '%';
    
    if (tips) {
        if (percentScore >= 80) {
            tips.innerHTML = '<span style="color: #10b981;">‚úÖ Exzellente Prompt-Qualit√§t! Bereit f√ºr optimale AI-Ergebnisse.</span>';
        } else if (percentScore >= 60) {
            tips.innerHTML = '<span style="color: #f59e0b;">üí° Gute Qualit√§t. F√ºgen Sie mehr Details hinzu f√ºr noch bessere Ergebnisse.</span>';
        } else if (percentScore >= 30) {
            tips.innerHTML = '<span style="color: #ef4444;">‚ö†Ô∏è Basis-Qualit√§t. Mehr Details = besserer Output!</span>';
        } else {
            tips.innerHTML = '<span style="color: #64748b;">F√ºllen Sie die Felder aus, um die Prompt-Qualit√§t zu erh√∂hen</span>';
        }
    }
}

renderPreview(prompt, fullPromptText) {
    let preview = this.escapeHtml(fullPromptText);
    
    if (prompt.questions && prompt.questions.length > 0) {
        prompt.questions.forEach((q, idx) => {
            const placeholder = `<span class="placeholder-text" id="placeholder-${prompt.id}-${idx}">[Eingabe erforderlich]</span>`;
            const questionText = this.escapeHtml(q.question);
            
            if (preview.includes(questionText)) {
                preview = preview.replace(questionText, questionText + '\n   ‚Üí ' + placeholder);
            }
        });
    }
    
    return preview;
}

    updateAnswer(promptId, questionIndex, value) {
        if (!this.userAnswers[promptId]) {
            this.userAnswers[promptId] = {};
        }
        this.userAnswers[promptId][questionIndex] = value;
    }

    copyPromptCode(promptId) {
        const codeElement = document.getElementById(`prompt-code-${promptId}`);
        if (codeElement) {
            navigator.clipboard.writeText(codeElement.textContent);
            alert('‚úÖ Prompt kopiert!');
        }
    }

    executePrompt(promptId) {
        const prompt = this.allPrompts.find(p => p.id === promptId);
        if (!prompt) return;

        // Get user answers
        const answers = this.userAnswers[promptId] || {};
        
        console.log('üöÄ Executing prompt:', prompt.name);
        console.log('üìù User answers:', answers);
        
        // TODO: Integrate with AI execution
        alert(`‚úÖ Prompt "${prompt.name}" wird ausgef√ºhrt!\n\n(AI-Integration folgt)`);
    }

    addToQueue(promptId) {
        const prompt = this.allPrompts.find(p => p.id === promptId);
        if (!prompt) return;

        const task = {
            id: Date.now(),
            title: prompt.name,
            agent: prompt.role || prompt.category,
            agentId: prompt.id,
            matchScore: 100,
            source: 'manual',
            timestamp: new Date().toISOString()
        };

        this.taskQueue.push(task);
        console.log('‚úÖ Added to queue:', task);
        alert(`‚úÖ "${prompt.name}" zur Task Queue hinzugef√ºgt!`);
    }

    /* ========================================== */
    /* FREE-FORM MODE */
    /* ========================================== */

    renderFreeFormMode() {
        return `
            <div class="prompts-freeform-section">
                <h2 class="section-title">üÜì Custom Prompt Builder</h2>
                <p class="section-subtitle">Erstelle deinen eigenen Prompt</p>
                
                <div class="freeform-builder">
                    <div class="form-group">
                        <label>Rolle / Agent</label>
                        <select class="form-control" id="freeform-role">
                            <option>Controller</option>
                            <option>Treasury</option>
                            <option>CFO</option>
                            <option>M&A</option>
                            <option>Bilanzbuchhalter</option>
                            <option>Business Developer</option>
                            <option>Fachanwalt</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Aufgabe / Ziel</label>
                        <textarea 
                            class="form-control" 
                            id="freeform-task" 
                            rows="3"
                            placeholder="Was m√∂chtest du erreichen?"
                        ></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Context / Details</label>
                        <textarea 
                            class="form-control" 
                            id="freeform-context" 
                            rows="5"
                            placeholder="Gib relevante Details und Kontext..."
                        ></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="window.promptsEngine.executeFreeForm()">
                        ‚ñ∂Ô∏è Prompt ausf√ºhren
                    </button>
                </div>
            </div>
        `;
    }

    executeFreeForm() {
        const role = document.getElementById('freeform-role')?.value;
        const task = document.getElementById('freeform-task')?.value;
        const context = document.getElementById('freeform-context')?.value;

        if (!task) {
            alert('‚ö†Ô∏è Bitte gib eine Aufgabe ein');
            return;
        }

        console.log('üöÄ Executing custom prompt:', { role, task, context });
        alert(`‚úÖ Custom Prompt wird ausgef√ºhrt!\n\n(AI-Integration folgt)`);
    }

    /* ========================================== */
    /* HELPER METHODS */
    /* ========================================== */

    getRoles() {
        const roleMap = new Map();
        
        this.allPrompts.forEach(prompt => {
            const role = prompt.category;
            if (!roleMap.has(role)) {
                roleMap.set(role, { name: role, count: 0 });
            }
            roleMap.get(role).count++;
        });
        
        return Array.from(roleMap.values()).sort((a, b) => b.count - a.count);
    }

    getRoleIcon(role) {
        const icons = {
            'Controller': 'üìä',
            'Treasury': 'üè¶',
            'Tax': 'üí∞',
            'CFO': 'üìà',
            'M&A': 'ü§ù',
            'Bilanzbuchhalter': 'üìö',
            'Business Developer': 'üöÄ',
            'Fachanwalt Gesellschaftsrecht': '‚öñÔ∏è',
            'Accountant': 'üíº',
            'Finance Manager': 'üíµ',
            'Auditor': 'üîç'
        };
        return icons[role] || 'üíº';
    }

    getAgentName(agentId) {
        const agents = {
            'controller': 'Controller',
            'treasury': 'Treasury Manager',
            'cfo': 'CFO',
            'ma': 'M&A Specialist',
            'accountant': 'Bilanzbuchhalter'
        };
        return agents[agentId] || 'Finance Expert';
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    setupEventListeners() {
        // Event listeners k√∂nnen hier hinzugef√ºgt werden
    }

    /* ========================================== */
    /* DATA LOADING */
    /* ========================================== */

    getAllPrompts() {
        const builtinPrompts = [];

        // Load Controller Prompts
        const controllerPrompts = (typeof NOTION_PROMPTS !== 'undefined' && Array.isArray(NOTION_PROMPTS)) 
            ? NOTION_PROMPTS 
            : [];

        // Load Treasury Prompts
        const treasuryPrompts = (typeof TREASURY_PROMPTS !== 'undefined' && Array.isArray(TREASURY_PROMPTS)) 
            ? TREASURY_PROMPTS 
            : [];

        // Load CFO Prompts
        const cfoPrompts = (typeof CFO_PROMPTS !== 'undefined' && Array.isArray(CFO_PROMPTS)) 
            ? CFO_PROMPTS 
            : [];

        // Load M&A Prompts
        const maPrompts = (typeof MA_PROMPTS !== 'undefined' && Array.isArray(MA_PROMPTS)) 
            ? MA_PROMPTS 
            : [];

        // Load Bilanzbuchhalter Prompts
        const bilanzPrompts = (typeof BILANZ_PROMPTS !== 'undefined' && Array.isArray(BILANZ_PROMPTS)) 
            ? BILANZ_PROMPTS 
            : [];

        // Load Business Developer Prompts
        const bizdevPrompts = (typeof BIZDEV_PROMPTS !== 'undefined' && Array.isArray(BIZDEV_PROMPTS)) 
            ? BIZDEV_PROMPTS 
            : [];

        // Load Fachanwalt Prompts
        const lawyerPrompts = (typeof LAWYER_PROMPTS !== 'undefined' && Array.isArray(LAWYER_PROMPTS)) 
            ? LAWYER_PROMPTS 
            : [];

        console.log(`üì¶ Loaded ${controllerPrompts.length} Controller prompts`);
        console.log(`üè¶ Loaded ${treasuryPrompts.length} Treasury prompts`);
        console.log(`üìà Loaded ${cfoPrompts.length} CFO prompts`);
        console.log(`ü§ù Loaded ${maPrompts.length} M&A prompts`);
        console.log(`üìö Loaded ${bilanzPrompts.length} Bilanzbuchhalter prompts`);
        console.log(`üöÄ Loaded ${bizdevPrompts.length} Business Developer prompts`);
        console.log(`‚öñÔ∏è Loaded ${lawyerPrompts.length} Fachanwalt prompts`);

        return [...builtinPrompts, ...controllerPrompts, ...treasuryPrompts, ...cfoPrompts, ...maPrompts, ...bilanzPrompts, ...bizdevPrompts, ...lawyerPrompts];
    }

    // 1. CSS Injection
    injectSplitScreenCSS() {
        if (document.getElementById('split-screen-styles')) return;

        const style = document.createElement('style');
        style.id = 'split-screen-styles';
        style.textContent = `
            .prompt-split-container {
                display: grid;
                grid-template-columns: 40% 60%;
                gap: 24px;
                margin-top: 24px;
            }
            .prompt-summary-sticky {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 24px;
                border-radius: 12px;
                margin-bottom: 20px;
            }
            .prompt-input-panel {
                background: white;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            }
            .prompt-preview-panel {
                background: white;
                border-radius: 12px;
                padding: 28px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.06);
                max-height: calc(100vh - 280px);
                overflow-y: auto;
            }
            .user-input-highlight {
                background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
                padding: 3px 8px;
                border-radius: 6px;
                font-weight: 600;
                color: #065f46;
                border-left: 3px solid #10b981;
                display: inline-block;
                animation: pulse-in 0.4s ease;
            }
            @keyframes pulse-in {
                0% { transform: scale(1); opacity: 0.8; }
                50% { transform: scale(1.05); opacity: 1; }
                100% { transform: scale(1); opacity: 1; }
            }
            .placeholder-text {
                background: #fef3c7;
                padding: 2px 6px;
                border-radius: 4px;
                font-style: italic;
                color: #92400e;
            }
            .progress-indicator {
                padding: 12px;
                border-radius: 6px;
                font-size: 13px;
                background: #fef3c7;
                border-left: 4px solid #f59e0b;
                color: #92400e;
            }
            .progress-indicator.complete {
                background: #f0fdf4;
                border-color: #10b981;
                color: #065f46;
            }
            @media (max-width: 1200px) {
                .prompt-split-container {
                    grid-template-columns: 1fr;
                }
            }
        `;
        document.head.appendChild(style);
    }

    // 2. Extract Questions from Prompt Text
    extractQuestionsFromPrompt(prompt) {
        const fullText = prompt.fullPromptText || '';
        
        const frageMatch = fullText.match(/\*\*üîç Bitte frage den Nutzer vorab\*\*([^]*?)(?=\n\n\*\*|$)/);
        
        if (!frageMatch) {
            return prompt.questions || [];
        }
        
        const frageSection = frageMatch[1];
        const lines = frageSection.split('\n');
        const extractedQuestions = [];
        
        let currentQuestion = null;
        
        for (const line of lines) {
            const trimmed = line.trim();
            const questionMatch = trimmed.match(/^(\d+)\.\s+(.+?)(\?|:)?\s*$/);
            
            if (questionMatch) {
                if (currentQuestion) {
                    extractedQuestions.push(currentQuestion);
                }
                
                currentQuestion = {
                    number: parseInt(questionMatch[1]),
                    question: questionMatch[2] + (questionMatch[3] || ''),
                    example: ''
                };
            } else if (trimmed.startsWith('‚Üí z. B.:') || trimmed.startsWith('‚Üí z.B.:')) {
                if (currentQuestion) {
                    const exampleText = trimmed.replace(/^‚Üí z\. ?B\.:\s*[‚Äû"]?/, '').replace(/[""]$/, '');
                    currentQuestion.example = exampleText;
                }
            }
        }
        
        if (currentQuestion) {
            extractedQuestions.push(currentQuestion);
        }
        
        return extractedQuestions;
    }

    // 3. Render Preview with Placeholders
    renderPreviewWithPlaceholders(prompt, fullPromptText, extractedQuestions) {
        let preview = this.escapeHtml(fullPromptText);
        
        extractedQuestions.forEach((q, idx) => {
            const questionText = this.escapeHtml(q.question);
            const placeholder = `<span class="placeholder-text" id="placeholder-${prompt.id}-${idx}">[Eingabe erforderlich]</span>`;
            
            const patterns = [
                `${q.number}. ${questionText}`,
                questionText
            ];
            
            for (const pattern of patterns) {
                if (preview.includes(pattern)) {
                    preview = preview.replace(
                        pattern,
                        `${pattern}\n   <strong style="color: #0ea5e9;">‚Üí Ihre Eingabe:</strong> ${placeholder}`
                    );
                    break;
                }
            }
        });
        
        if (extractedQuestions.length > 0) {
            const additionalPlaceholder = `<span class="placeholder-text" id="additional-placeholder-${prompt.id}">[Keine zus√§tzlichen Hinweise]</span>`;
            preview += `\n\n<strong style="color: #0ea5e9;">‚ûï Zus√§tzliche Hinweise:</strong>\n${additionalPlaceholder}`;
        }
        
        return preview;
    }

    // 4. Extract Summary
    extractSummary(prompt) {
        let text = prompt.fullPromptText || prompt.goal || '';
        text = text.replace(/\*\*/g, '').replace(/\n/g, ' ');
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
        const summary = sentences.slice(0, 2).join(' ');
        return summary.length > 250 ? summary.substring(0, 250) + '...' : summary;
    }

    // 5. Update Live Preview (√úBERSCHREIBT ALTE METHODE)
    updateLivePreview(promptId, fieldIndex, value, questionText) {
        const placeholder = document.getElementById(`placeholder-${promptId}-${fieldIndex}`);
        
        if (placeholder) {
            if (value && value.trim() !== '') {
                placeholder.className = 'user-input-highlight';
                placeholder.textContent = value;
            } else {
                placeholder.className = 'placeholder-text';
                placeholder.textContent = '[Eingabe erforderlich]';
            }
        }

        if (!this.userAnswers[promptId]) {
            this.userAnswers[promptId] = {};
        }
        this.userAnswers[promptId][fieldIndex] = value;

        const prompt = this.allPrompts.find(p => p.id === promptId);
        if (prompt) {
            const extractedQuestions = this.extractQuestionsFromPrompt(prompt);
            this.updateProgress(promptId, extractedQuestions.length);
        }
    }

    // 6. Update Additional Hints
    updateAdditionalHints(promptId, value) {
        const placeholder = document.getElementById(`additional-placeholder-${promptId}`);
        
        if (placeholder) {
            if (value && value.trim() !== '') {
                placeholder.className = 'user-input-highlight';
                placeholder.style.display = 'block';
                placeholder.style.padding = '12px';
                placeholder.style.marginTop = '8px';
                placeholder.textContent = value;
            } else {
                placeholder.className = 'placeholder-text';
                placeholder.style.display = 'inline';
                placeholder.style.padding = '2px 6px';
                placeholder.style.marginTop = '0';
                placeholder.textContent = '[Keine zus√§tzlichen Hinweise]';
            }
        }

        if (!this.userAnswers[promptId]) {
            this.userAnswers[promptId] = {};
        }
        this.userAnswers[promptId]['additional'] = value;
    }

    // üÜï ========== ENDE NEUE METHODEN ==========

    // üÜï Business Partner Context
    getQuestionContext(question, index, category) {
        // ... siehe BUSINESS_PARTNER_UPGRADE.js
    }

    // üÜï Smart Placeholders
    getSmartPlaceholder(question, example) {
        // ... siehe BUSINESS_PARTNER_UPGRADE.js
    }

    // üÜï Validation
    updateLivePreviewWithValidation(promptId, fieldIndex, value, questionText) {
        // ... siehe BUSINESS_PARTNER_UPGRADE.js
    }

    // üÜï Input Validation
    validateInput(value, questionText) {
        // ... siehe BUSINESS_PARTNER_UPGRADE.js
    }

    // üÜï Quality Score Init
    initializeQualityScore(promptId, totalFields) {
        // ... siehe BUSINESS_PARTNER_UPGRADE.js
    }

    // üÜï Quality Score Update
    updateQualityScore(promptId, totalFields) {
        // ... siehe BUSINESS_PARTNER_UPGRADE.js
    }
}

// Initialize when DOM is ready
if (typeof window !== 'undefined') {
    window.PromptsEngine = PromptsEngine;
    console.log('‚úÖ PromptsEngine (3-Level) class loaded');
    
    // Global init function for navigation
    window.initPromptsTab = function() {
        console.log('üéØ initPromptsTab() called');
        
        if (!window.promptsEngine) {
            console.log('üì¶ Creating new PromptsEngine instance...');
            window.promptsEngine = new PromptsEngine();
        }
        
        window.promptsEngine.init();
        console.log('‚úÖ Prompts Engine initialized and rendered');
    };
    
    // Auto-initialize when prompts container exists
    document.addEventListener('DOMContentLoaded', function() {
        const promptsContainer = document.getElementById('prompts-content');
        if (promptsContainer) {
            console.log('üéØ Auto-initializing Prompts Engine (DOMContentLoaded)...');
            window.initPromptsTab();
        }
    });
    
    // Also check after a short delay (for dynamic content loading)
    setTimeout(function() {
        if (!window.promptsEngine) {
            const promptsContainer = document.getElementById('prompts-content');
            if (promptsContainer) {
                console.log('üéØ Auto-initializing Prompts Engine (delayed)...');
                window.initPromptsTab();
            }
        }
    }, 500);
}
